<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on krzjoa</title>
    <link>/post/</link>
    <description>Recent content in Posts on krzjoa</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Sat, 05 Mar 2022 00:00:00 +0000</lastBuildDate><atom:link href="/post/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Conditional RNN in keras (R) to deal with static features</title>
      <author>joachimiak.krzysztof@gmail.com (Krzysztof Joachimiak)</author>
      <link>/2022/03/05/content/post/2022-03-05-conditional-rnn-in-keras-r/</link>
      <pubDate>Sat, 05 Mar 2022 00:00:00 +0000</pubDate>
      
      <guid>/2022/03/05/content/post/2022-03-05-conditional-rnn-in-keras-r/</guid>
      <description>&lt;p&gt;&lt;a&gt;&lt;img src=&#39;/post/2022-03-05-conditional-rnn-in-keras-r/keras.png&#39; align=&#34;center&#34;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Conditional RNN is one of the possible solutions if we’d like to make
use of &lt;strong&gt;static features&lt;/strong&gt; in time series forecasting. For example, we
want to build a model, which can handle multiple time series with many
different characteristics. It can be a model for demand forecasting for
multiple products or a unified model forecasting temperature in places
from different climate zones.&lt;/p&gt;
&lt;p&gt;We have at least a couple of options to do so. They are described in
detail in the following &lt;a href=&#34;https://datascience.stackexchange.com/questions/17099/adding-features-to-time-series-model-lstm/17139#17139&#34;&gt;thread on
StackOverlow&lt;/a&gt;.
According to the answers, the best way to add static features is to use
this values to produce an initial hidden state of the recurrent layer.
The proposed solution was &lt;a href=&#34;https://github.com/philipperemy/cond_rnn&#34;&gt;implemented as a Keras wrapper to recurrent
layers (in Python)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This post is a trial to implement conditional RNN in keras for R.&lt;/p&gt;
&lt;h2 id=&#34;loading-the-data&#34;&gt;Loading the data&lt;/h2&gt;
&lt;p&gt;We’ll use a piece of data from an experiment performed by the author of
the &lt;a href=&#34;https://github.com/philipperemy/cond_rnn/raw/master/examples/temperature/city_temperature.csv.zip&#34;&gt;aforementioned Keras
wrapper&lt;/a&gt;.
We’re selecting two cities with extreme temperatures, e.g. &lt;strong&gt;Cairo&lt;/strong&gt;
and &lt;strong&gt;Helsinki&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(data.table, warn.conflicts &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(dplyr, warn.conflicts &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(lubridate)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(ggplot2)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(imputeTS
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(timetk)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(rsample)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(parsnip)

&lt;span style=&#34;color:#75715e&#34;&gt;# url       &amp;lt;- &amp;#34;https://github.com/philipperemy/cond_rnn/raw/master/examples/temperature/city_temperature.csv.zip&amp;#34;&lt;/span&gt;
file_path &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;city_temperature.csv.zip&amp;#34;&lt;/span&gt;
csv_path  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;city_temperature.csv&amp;#34;&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# download.file(url, file_path)&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# unzip(file_path)&lt;/span&gt;

city_temperature &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;read.csv&lt;/span&gt;(csv_path)
&lt;span style=&#34;color:#a6e22e&#34;&gt;setDT&lt;/span&gt;(city_temperature)

selected_cities &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  city_temperature[City &lt;span style=&#34;color:#f92672&#34;&gt;%chin%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Cairo&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Helsinki&amp;#39;&lt;/span&gt;)]

selected_cities[
  , Date &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ymd&lt;/span&gt;(glue&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;glue&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;{Year}-{Month}-{Day}&amp;#34;&lt;/span&gt;, .envir &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; .SD))
]

selected_cities &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  selected_cities[, .(City, Date, AvgTemperature)]
&lt;span style=&#34;color:#a6e22e&#34;&gt;setorder&lt;/span&gt;(selected_cities, City, Date)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;plt &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(selected_cities) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(Date, AvgTemperature, col &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; City)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;theme_minimal&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;ggtitle&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Temperature: Cairo vs Helsinki&amp;#34;&lt;/span&gt;)

plt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;index_files/figure-markdown_strict/selecting.data-1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;There is a couple of outliers and we can safely assume they simply
indicate lack of data. We’ll replace it with interpolated values.&lt;/p&gt;
&lt;p&gt;Initially, I’ve chosen Oslo, but there were a few corrupted year
numbers:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;city_temperature[City &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Oslo&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; Year &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;200&lt;/span&gt;]

&lt;span style=&#34;color:#75715e&#34;&gt;##     Region Country State City Month Day Year AvgTemperature&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  1: Europe  Norway       Oslo    12   1  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  2: Europe  Norway       Oslo    12   2  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  3: Europe  Norway       Oslo    12   3  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  4: Europe  Norway       Oslo    12   4  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  5: Europe  Norway       Oslo    12   5  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  6: Europe  Norway       Oslo    12   6  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  7: Europe  Norway       Oslo    12   7  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  8: Europe  Norway       Oslo    12   8  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##  9: Europe  Norway       Oslo    12   9  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 10: Europe  Norway       Oslo    12  10  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 11: Europe  Norway       Oslo    12  11  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 12: Europe  Norway       Oslo    12  12  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 13: Europe  Norway       Oslo    12  13  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 14: Europe  Norway       Oslo    12  14  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 15: Europe  Norway       Oslo    12  15  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 16: Europe  Norway       Oslo    12  16  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 17: Europe  Norway       Oslo    12  17  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 18: Europe  Norway       Oslo    12  18  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 19: Europe  Norway       Oslo    12  19  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 20: Europe  Norway       Oslo    12  20  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 21: Europe  Norway       Oslo    12  21  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 22: Europe  Norway       Oslo    12  22  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 23: Europe  Norway       Oslo    12  23  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 24: Europe  Norway       Oslo    12  24  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 25: Europe  Norway       Oslo    12  25  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 26: Europe  Norway       Oslo    12  26  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 27: Europe  Norway       Oslo    12  27  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 28: Europe  Norway       Oslo    12  28  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 29: Europe  Norway       Oslo    12  29  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 30: Europe  Norway       Oslo    12  30  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 31: Europe  Norway       Oslo    12  31  200            -99&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##     Region Country State City Month Day Year AvgTemperature&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# Cleaning the data&lt;/span&gt;
selected_cities[AvgTemperature &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;-99.0&lt;/span&gt;, AvgTemperature &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;]
selected_cities[, AvgTemperature &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;na_interpolation&lt;/span&gt;(AvgTemperature)]

plt &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(selected_cities) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(Date, AvgTemperature, col &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; City)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;theme_minimal&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;ggtitle&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Temperature: Cairo vs Helsinki&amp;#34;&lt;/span&gt;)

plt
&lt;span style=&#34;color:#75715e&#34;&gt;# plotly::ggplotly(plt)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;index_files/figure-markdown_strict/removing.outliers-1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(tsibble, warn.conflicts &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt;, quietly &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;)

&lt;span style=&#34;color:#a6e22e&#34;&gt;duplicates&lt;/span&gt;(selected_cities, key &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; City, index &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Date)

&lt;span style=&#34;color:#75715e&#34;&gt;## # A tibble: 4 × 3&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##   City     Date       AvgTemperature&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;##   &amp;lt;chr&amp;gt;    &amp;lt;date&amp;gt;              &amp;lt;dbl&amp;gt;&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 1 Cairo    2015-12-30           60.5&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 2 Cairo    2015-12-30           57.9&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 3 Helsinki 2015-12-30           26.6&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;## 4 Helsinki 2015-12-30           25.4&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# Removing dupicates for &lt;/span&gt;
selected_cities &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  selected_cities[, .(AvgTemperature &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;max&lt;/span&gt;(AvgTemperature)) , by &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; .(City, Date)]

train &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; selected_cities[Date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;2019-01-01&amp;#39;&lt;/span&gt;)]
test  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; selected_cities[
  Date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;2019-01-01&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; Date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;2019-12-31&amp;#39;&lt;/span&gt;)
]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;baseline-model---one-xgboost-model-for-both-cities&#34;&gt;Baseline model - one xgboost model for both cities&lt;/h2&gt;
&lt;p&gt;As a baseline model, we’ll train a &lt;code&gt;xgboost&lt;/code&gt; model using &lt;code&gt;parsnip&lt;/code&gt; API
and &lt;code&gt;modeltime&lt;/code&gt;. We create a &lt;code&gt;data.frame&lt;/code&gt; of lagged variables to feed
the model. We use &lt;strong&gt;28 lags&lt;/strong&gt; - the same value will be later used as a
length of input to the &lt;strong&gt;recurrent neural netowrk&lt;/strong&gt; models. We also mix
the data belonging to different cities, so there are no separate
models for each city.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(modeltime)

lagged_selected_cities &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  selected_cities &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;group_by&lt;/span&gt;(City) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;tk_augment_lags&lt;/span&gt;(AvgTemperature, .lags &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;28&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;ungroup&lt;/span&gt;()

&lt;span style=&#34;color:#a6e22e&#34;&gt;setDT&lt;/span&gt;(lagged_selected_cities)

train &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; lagged_selected_cities[Date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;2019-01-01&amp;#39;&lt;/span&gt;)]
test  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; lagged_selected_cities[
  Date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;2019-01-01&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt; Date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;2019-12-31&amp;#39;&lt;/span&gt;)
]

lagged_variables &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; glue&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;glue&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;AvgTemperature_lag{1:28}&amp;#34;&lt;/span&gt;)
formula_rhs      &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste0&lt;/span&gt;(lagged_variables, collapse &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; + &amp;#34;&lt;/span&gt;)
model_formula    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.formula&lt;/span&gt;(
  glue&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;glue&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;AvgTemperature ~ {formula_rhs}&amp;#34;&lt;/span&gt;)
)

model_xgboost &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;boost_tree&lt;/span&gt;(mode &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;regression&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;set_engine&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;xgboost&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;fit&lt;/span&gt;(model_formula, data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; train)

fcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  model_xgboost &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;predict&lt;/span&gt;(test)

mdltime &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;modeltime_table&lt;/span&gt;(
    xgboost &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; model_xgboost
  )

fcast_cairo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  mdltime &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;modeltime_forecast&lt;/span&gt;(
    test[City &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Cairo&amp;#39;&lt;/span&gt;], actual_data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; test[City &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Cairo&amp;#39;&lt;/span&gt;]
  ) 

fcast_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  mdltime &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;modeltime_forecast&lt;/span&gt;(
    test[City &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Helsinki&amp;#39;&lt;/span&gt;], actual_data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; test[City &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Helsinki&amp;#39;&lt;/span&gt;]
  ) 

fcast_cairo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  fcast_cairo &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Cairo&amp;#39;&lt;/span&gt;)

fcast_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  fcast_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Helsinki&amp;#39;&lt;/span&gt;)

fcast_xgboost &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;bind_rows&lt;/span&gt;(
    fcast_cairo, fcast_helsinki
  ) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;filter&lt;/span&gt;(.key &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;prediction&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;select&lt;/span&gt;(.index, .value, name) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;rename&lt;/span&gt;(Date &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; .index, value &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; .value) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;xgboost&amp;#39;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let’s take a glance, how the models’ predictions look like.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;fcast_xgboost_cmp &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;bind_rows&lt;/span&gt;(
    fcast_xgboost,
    &lt;span style=&#34;color:#a6e22e&#34;&gt;select&lt;/span&gt;(test, Date, name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; City, value &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; AvgTemperature) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
      &lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;actual&amp;#39;&lt;/span&gt;)
  )

&lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(fcast_xgboost_cmp) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(Date, value, col &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; model)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;facet_wrap&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;name) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;theme_minimal&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;index_files/figure-markdown_strict/xgboost.plot-1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;As we can see, &lt;code&gt;xgboost&lt;/code&gt; models fitted to the data quite well. However,
the task was relatively simple, because we only wanted to forecast one
timestep ahead.&lt;/p&gt;
&lt;h2 id=&#34;preparing-data-for-rnns&#34;&gt;Preparing data for RNNs&lt;/h2&gt;
&lt;p&gt;We pass to the ‘main course’ - training recurrent neural networks.
First, we create a couple of auxiliary functions to create input
tensors:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;3-dimensional tensors&lt;/strong&gt; for input time series&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;matrices&lt;/strong&gt; for outputs and static variables&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(abind)

ndim &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;dim&lt;/span&gt;(x))
}

shuffle &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;){

  objects     &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;)
  object_size &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dim&lt;/span&gt;(objects[[1]])[1]
  
  indices &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sample&lt;/span&gt;(object_size,  object_size)
  
  &lt;span style=&#34;color:#a6e22e&#34;&gt;Map&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;\&lt;/span&gt;(x) &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;ndim&lt;/span&gt;(x) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;) x[indices, ] else x[indices, ,], objects)
}

prepare_output &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(fcast, idx){

  idx_cairo    &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; idx &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
  idx_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; idx &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
    
  fcast_cairo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    fcast[idx_cairo, ] &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;as.vector&lt;/span&gt;()
  
  fcast_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    fcast[idx_helsinki, ] &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;as.vector&lt;/span&gt;()
  
  fcast_df &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;data.table&lt;/span&gt;(
      Date &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; test&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;Date[1&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(fcast_cairo)],
      Cairo &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; fcast_cairo,
      Helsinki &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; fcast_helsinki
    ) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    tidyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;pivot_longer&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(Cairo, Helsinki))
  
    fcast_df
}

prepare_data &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(data, timesteps, horizon, jump, 
                       sample_frac, targets &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;, .shuffle &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;){

  data_period_length &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;max&lt;/span&gt;(data&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;Date) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;min&lt;/span&gt;(data&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;Date)
  data_period_length &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.numeric&lt;/span&gt;(data_period_length) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
  
  n &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; data_period_length &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; timesteps &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; horizon &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
  
  starts &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, n, jump)
  starts &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sample&lt;/span&gt;(starts, size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(starts) &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; sample_frac)
  starts &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sort&lt;/span&gt;(starts)
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Cairo&lt;/span&gt;
  data_cairo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    data[City &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Cairo&amp;#39;&lt;/span&gt;, .(AvgTemperature)]
  
  x_data_cairo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    purrr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;map&lt;/span&gt;(
      starts, 
      &lt;span style=&#34;color:#a6e22e&#34;&gt;\&lt;/span&gt;(i) &lt;span style=&#34;color:#a6e22e&#34;&gt;array&lt;/span&gt;(data_cairo[i&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;i&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;timesteps&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;, ]&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;AvgTemperature, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, timesteps, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
    )
  
  x_data_cairo        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;abind&lt;/span&gt;(x_data_cairo, along &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
  x_data_static_cairo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;dim&lt;/span&gt;(x_data_cairo)[1], &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) 
  
  y_data_cairo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
      purrr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;map&lt;/span&gt;(
        starts, 
        &lt;span style=&#34;color:#a6e22e&#34;&gt;\&lt;/span&gt;(i) &lt;span style=&#34;color:#a6e22e&#34;&gt;array&lt;/span&gt;(data_cairo&lt;span style=&#34;color:#a6e22e&#34;&gt;[&lt;/span&gt;(i&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;timesteps)&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;(i&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;timesteps&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;horizon&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;), ]&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;AvgTemperature, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, horizon))
      )
  y_data_cairo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;abind&lt;/span&gt;(y_data_cairo, along &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Helsinki&lt;/span&gt;
  data_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    data[City &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Helsinki&amp;#39;&lt;/span&gt;, .(AvgTemperature)]
  
  x_data_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    purrr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;map&lt;/span&gt;(
      starts, 
      &lt;span style=&#34;color:#a6e22e&#34;&gt;\&lt;/span&gt;(i) &lt;span style=&#34;color:#a6e22e&#34;&gt;array&lt;/span&gt;(data_helsinki[i&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;i&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;timesteps&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;, ]&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;AvgTemperature, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, timesteps, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
    )
  
  x_data_helsinki        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;abind&lt;/span&gt;(x_data_helsinki, along &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
  x_data_static_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;dim&lt;/span&gt;(x_data_helsinki)[1], &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) 
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Complete data&lt;/span&gt;
  x_data        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;abind&lt;/span&gt;(x_data_cairo, x_data_helsinki, along &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
  x_static_data &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;abind&lt;/span&gt;(x_data_static_cairo, x_data_static_helsinki, along &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) 
  
  right_order &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(targets) {
      y_data_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
      purrr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;map&lt;/span&gt;(
        starts, 
        &lt;span style=&#34;color:#a6e22e&#34;&gt;\&lt;/span&gt;(i) &lt;span style=&#34;color:#a6e22e&#34;&gt;array&lt;/span&gt;(data_helsinki&lt;span style=&#34;color:#a6e22e&#34;&gt;[&lt;/span&gt;(i&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;timesteps)&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;(i&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;timesteps&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;horizon&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;), ]&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;AvgTemperature, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, horizon))
      )
      
      y_data_helsinki &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;abind&lt;/span&gt;(y_data_helsinki, along &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
      y               &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;abind&lt;/span&gt;(y_data_cairo, y_data_helsinki, along &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
      
      &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(.shuffle)
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;shuffle&lt;/span&gt;(x_data, x_static_data, y))
      else
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(x_data, x_static_data, y))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(.shuffle)
      &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;shuffle&lt;/span&gt;(x_data, x_static_data))
    else 
      &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(x_data, x_static_data))
  }

}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Experiment configuration:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;TIMESTEPS        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;28&lt;/span&gt;
HORIZON_1        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
HORIZON_7        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;

DYNAMIC_FEATURES &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
STATIC_FEATURES  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
RNN_UNITS        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;
VOCABULARY_SIZE  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# because we have two cities&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Importing &lt;code&gt;keras&lt;/code&gt;, we’re also loading multiple assignment operator from
&lt;code&gt;zeallot&lt;/code&gt;, namely &lt;code&gt;%&amp;lt;-%&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(keras)

JUMP        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
SAMPLE_FRAC &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# HORIZON = 1&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# Training data&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(x_train_h1, x_static_train_h1, y_h1) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;lt;-%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;prepare_data&lt;/span&gt;(
    data        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; train,
    timesteps   &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; TIMESTEPS,
    horizon     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_1,
    jump        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_1,
    sample_frac &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; SAMPLE_FRAC
  )

&lt;span style=&#34;color:#75715e&#34;&gt;# Test data&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(x_test_h1, x_static_test_h1) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;lt;-%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;prepare_data&lt;/span&gt;(
    data        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; test,
    timesteps   &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; TIMESTEPS,
    horizon     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_1,
    jump        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_1,
    sample_frac &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
    targets     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt;,
    .shuffle    &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt; 
  )

&lt;span style=&#34;color:#75715e&#34;&gt;# HORIZON = 7&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# Training data&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(x_train_h7, x_static_train_h7, y_h7) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;lt;-%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;prepare_data&lt;/span&gt;(
    data        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; train,
    timesteps   &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; TIMESTEPS,
    horizon     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_7,
    jump        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
    sample_frac &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; SAMPLE_FRAC
  )

&lt;span style=&#34;color:#75715e&#34;&gt;# Test data&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(x_test_h7, x_static_test_h7) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;lt;-%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;prepare_data&lt;/span&gt;(
    data        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; test,
    timesteps   &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; TIMESTEPS,
    horizon     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_7,
    jump        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_7,
    sample_frac &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,
    targets     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt;,
    .shuffle    &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt; 
  )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;conditional-rnn&#34;&gt;Conditional RNN&lt;/h2&gt;
&lt;p&gt;The idea of &lt;strong&gt;conditional RNN&lt;/strong&gt; is to initialize hidden states of the
recurrent layer using specially prepared values, which indicate a
specific type of the time series.&lt;/p&gt;
&lt;p&gt;I let myself for some simplifications in these experiments, e.g.:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;data is not scaled&lt;/li&gt;
&lt;li&gt;validation data is not used to prevent overfitting&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;experiment_conditional_rnn &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(timesteps, horizon, rnn_units, 
            vocabulary_size, dynamic_features, static_features,
            model, x_train, x_static_train, y, x_test, x_static_test){

  &lt;span style=&#34;color:#75715e&#34;&gt;# Model&lt;/span&gt;
  ts_input     &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_input&lt;/span&gt;(shape &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(timesteps, dynamic_features))
  static_input &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_input&lt;/span&gt;(shape &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; static_features)
  
  embedding &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_embedding&lt;/span&gt;(input_dim &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; vocabulary_size, 
                               output_dim &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rnn_units)(static_input)
  embedding &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_lambda&lt;/span&gt;(f &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;\&lt;/span&gt;(x) x[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,])(embedding)
  
  rnn_layer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_gru&lt;/span&gt;(units &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rnn_units, name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;rnn&amp;#39;&lt;/span&gt;)(ts_input, initial_state &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; embedding)
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# For LSTM layers we have to provide two hidden state values&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# rnn_layer &amp;lt;- &lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;#  layer_gru(units = rnn_units, name = &amp;#39;rnn&amp;#39;)(ts_input, initial_state = list(embedding, embedding))&lt;/span&gt;
  
  final_layer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_dense&lt;/span&gt;(units &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; horizon, activation &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;linear&amp;#39;&lt;/span&gt;)(rnn_layer)
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Compiling&lt;/span&gt;
  net &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;keras_model&lt;/span&gt;(
      inputs  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(ts_input, static_input),
      outputs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(final_layer) 
    ) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;compile&lt;/span&gt;(
      optimizer &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;adam&amp;#39;&lt;/span&gt;,
      loss      &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;mae&amp;#39;&lt;/span&gt;
    )
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Training&lt;/span&gt;
  net &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;fit&lt;/span&gt;(
      x &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(x_train, x_static_train),
      y &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(y),
      epochs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;,
      batch_size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;
    )

  &lt;span style=&#34;color:#75715e&#34;&gt;# Forecasting&lt;/span&gt;
  fcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    net &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;predict&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(x_test, x_static_test))
  

  fcast_df &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;prepare_output&lt;/span&gt;(fcast, x_static_test)
  fcast_df&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;model &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; model

  &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(net, fcast_df)
}

&lt;span style=&#34;color:#75715e&#34;&gt;# HORIZON = 1&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(net_cond_h1, fcast_cond_h1) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;lt;-%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;experiment_conditional_rnn&lt;/span&gt;(
    &lt;span style=&#34;color:#75715e&#34;&gt;# Network&lt;/span&gt;
    timesteps        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; TIMESTEPS,
    vocabulary_size  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; VOCABULARY_SIZE,
    dynamic_features &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; DYNAMIC_FEATURES,
    static_features  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; STATIC_FEATURES,
    horizon          &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_1,
    rnn_units        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; RNN_UNITS,
    model            &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;cond_rnn_h1&amp;#39;&lt;/span&gt;,
    &lt;span style=&#34;color:#75715e&#34;&gt;# Data&lt;/span&gt;
    x_train          &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_train_h1,
    x_static_train   &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_static_train_h1,
    y                &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; y_h1,
    x_test           &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_test_h1,
    x_static_test    &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_static_test_h1
  )

&lt;span style=&#34;color:#75715e&#34;&gt;## Loaded Tensorflow version 2.8.0&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# HORIZON = 7&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(net_cond_h7, fcast_cond_h7) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;lt;-%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;experiment_conditional_rnn&lt;/span&gt;(
    &lt;span style=&#34;color:#75715e&#34;&gt;# Network&lt;/span&gt;
    timesteps        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; TIMESTEPS,
    vocabulary_size  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; VOCABULARY_SIZE,
    dynamic_features &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; DYNAMIC_FEATURES,
    static_features  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; STATIC_FEATURES,
    horizon          &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_7,
    rnn_units        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; RNN_UNITS,
    model            &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;cond_rnn_h7&amp;#39;&lt;/span&gt;,
    &lt;span style=&#34;color:#75715e&#34;&gt;# Data&lt;/span&gt;
    x_train          &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_train_h7,
    x_static_train   &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_static_train_h7,
    y                &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; y_h7,
    x_test           &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_test_h7,
    x_static_test    &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_static_test_h7
  )

fcast_cond_cmp &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;bind_rows&lt;/span&gt;(
    fcast_cond_h1,
    fcast_cond_h7,
    &lt;span style=&#34;color:#a6e22e&#34;&gt;select&lt;/span&gt;(test, Date, name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; City, value &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; AvgTemperature) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
      &lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;actual&amp;#39;&lt;/span&gt;)
  )

&lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(fcast_cond_cmp) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(Date, value, col &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; model)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;facet_wrap&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;name) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;theme_minimal&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;index_files/figure-markdown_strict/cond.plot-1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;simple-rnn&#34;&gt;Simple RNN&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;experiment_simple_rnn &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(timesteps, horizon, rnn_units,
           model, x_train, y, x_test, x_static_test){
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Network architecture&lt;/span&gt;
  ts_input  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_input&lt;/span&gt;(shape &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(timesteps, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
  rnn_layer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_gru&lt;/span&gt;(units &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; rnn_units, name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;rnn&amp;#39;&lt;/span&gt;)(ts_input)
  
  final_layer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;layer_dense&lt;/span&gt;(units &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; horizon, activation &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;linear&amp;#39;&lt;/span&gt;)(rnn_layer)
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Compiling&lt;/span&gt;
  net &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;keras_model&lt;/span&gt;(
      inputs  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(ts_input),
      outputs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(final_layer) 
    ) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;compile&lt;/span&gt;(
      optimizer &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;adam&amp;#39;&lt;/span&gt;,
      loss      &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;mae&amp;#39;&lt;/span&gt;
    )
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Training &lt;/span&gt;
  net &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;fit&lt;/span&gt;(
      x &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(x_train),
      y &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(y),
      epochs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;,
      batch_size &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;
    )
  
  &lt;span style=&#34;color:#75715e&#34;&gt;# Forecasting&lt;/span&gt;
  fcast &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
    net &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;predict&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(x_test))
  
  fcast_df &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;prepare_output&lt;/span&gt;(fcast, x_static_test)
  fcast_df&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;model &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; model

  &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(net, fcast_df)     
}

&lt;span style=&#34;color:#75715e&#34;&gt;# HORIZON = 1&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(net_simple_h1, fcast_simple_h1) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;lt;-%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;experiment_simple_rnn&lt;/span&gt;(
    &lt;span style=&#34;color:#75715e&#34;&gt;# Network&lt;/span&gt;
    timesteps     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; TIMESTEPS,
    horizon       &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_1,
    rnn_units     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;,
    model         &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;simple_rnn_h1&amp;#39;&lt;/span&gt;,
    &lt;span style=&#34;color:#75715e&#34;&gt;# Data&lt;/span&gt;
    x_train       &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_train_h1,
    y             &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; y_h1,
    x_test        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_test_h1,
    x_static_test &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_static_test_h1
  )

&lt;span style=&#34;color:#75715e&#34;&gt;# HORIZON = 7&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(net_simple_h7, fcast_simple_h7) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;lt;-%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;experiment_simple_rnn&lt;/span&gt;(
    &lt;span style=&#34;color:#75715e&#34;&gt;# Network&lt;/span&gt;
    timesteps     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; TIMESTEPS,
    horizon       &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; HORIZON_7,
    rnn_units     &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;32&lt;/span&gt;,
    model         &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;simple_rnn_h7&amp;#39;&lt;/span&gt;,
    &lt;span style=&#34;color:#75715e&#34;&gt;# Data&lt;/span&gt;
    x_train       &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_train_h7,
    y             &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; y_h7,
    x_test        &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_test_h7,
    x_static_test &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; x_static_test_h7
  )

fcast_simple_cmp &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;bind_rows&lt;/span&gt;(
    fcast_simple_h1,
    fcast_simple_h7,
    &lt;span style=&#34;color:#a6e22e&#34;&gt;select&lt;/span&gt;(test, Date, name &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; City, value &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; AvgTemperature) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
      &lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;actual&amp;#39;&lt;/span&gt;)
  )

&lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(fcast_simple_cmp) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(Date, value, col &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; model)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;facet_wrap&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;name) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;theme_minimal&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;index_files/figure-markdown_strict/simple.plot-1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(yardstick)

fcast_df &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;bind_rows&lt;/span&gt;(
    fcast_xgboost,
    fcast_cond_h1,
    fcast_cond_h7,
    fcast_simple_h1,
    fcast_simple_h7
  )

fcast_df &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  fcast_df &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;left_join&lt;/span&gt;(test &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;select&lt;/span&gt;(Date, City, AvgTemperature), 
            by &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Date&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;name&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;City&amp;#39;&lt;/span&gt;))

fcast_df &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;group_by&lt;/span&gt;(model) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;summarise&lt;/span&gt;(mape &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;mape_vec&lt;/span&gt;(AvgTemperature, value)) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  gt&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;gt&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div id=&#34;zpafsdmqom&#34; style=&#34;overflow-x:auto;overflow-y:auto;width:auto;height:auto;&#34;&gt;
&lt;style&gt;html {
  font-family: -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, Oxygen, Ubuntu, Cantarell, &#39;Helvetica Neue&#39;, &#39;Fira Sans&#39;, &#39;Droid Sans&#39;, Arial, sans-serif;
}
&lt;p&gt;#zpafsdmqom .gt_table {
display: table;
border-collapse: collapse;
margin-left: auto;
margin-right: auto;
color: #333333;
font-size: 16px;
font-weight: normal;
font-style: normal;
background-color: #FFFFFF;
width: auto;
border-top-style: solid;
border-top-width: 2px;
border-top-color: #A8A8A8;
border-right-style: none;
border-right-width: 2px;
border-right-color: #D3D3D3;
border-bottom-style: solid;
border-bottom-width: 2px;
border-bottom-color: #A8A8A8;
border-left-style: none;
border-left-width: 2px;
border-left-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_heading {
background-color: #FFFFFF;
text-align: center;
border-bottom-color: #FFFFFF;
border-left-style: none;
border-left-width: 1px;
border-left-color: #D3D3D3;
border-right-style: none;
border-right-width: 1px;
border-right-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_title {
color: #333333;
font-size: 125%;
font-weight: initial;
padding-top: 4px;
padding-bottom: 4px;
padding-left: 5px;
padding-right: 5px;
border-bottom-color: #FFFFFF;
border-bottom-width: 0;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_subtitle {
color: #333333;
font-size: 85%;
font-weight: initial;
padding-top: 0;
padding-bottom: 6px;
padding-left: 5px;
padding-right: 5px;
border-top-color: #FFFFFF;
border-top-width: 0;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_bottom_border {
border-bottom-style: solid;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_col_headings {
border-top-style: solid;
border-top-width: 2px;
border-top-color: #D3D3D3;
border-bottom-style: solid;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
border-left-style: none;
border-left-width: 1px;
border-left-color: #D3D3D3;
border-right-style: none;
border-right-width: 1px;
border-right-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_col_heading {
color: #333333;
background-color: #FFFFFF;
font-size: 100%;
font-weight: normal;
text-transform: inherit;
border-left-style: none;
border-left-width: 1px;
border-left-color: #D3D3D3;
border-right-style: none;
border-right-width: 1px;
border-right-color: #D3D3D3;
vertical-align: bottom;
padding-top: 5px;
padding-bottom: 6px;
padding-left: 5px;
padding-right: 5px;
overflow-x: hidden;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_column_spanner_outer {
color: #333333;
background-color: #FFFFFF;
font-size: 100%;
font-weight: normal;
text-transform: inherit;
padding-top: 0;
padding-bottom: 0;
padding-left: 4px;
padding-right: 4px;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_column_spanner_outer:first-child {
padding-left: 0;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_column_spanner_outer:last-child {
padding-right: 0;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_column_spanner {
border-bottom-style: solid;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
vertical-align: bottom;
padding-top: 5px;
padding-bottom: 5px;
overflow-x: hidden;
display: inline-block;
width: 100%;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_group_heading {
padding-top: 8px;
padding-bottom: 8px;
padding-left: 5px;
padding-right: 5px;
color: #333333;
background-color: #FFFFFF;
font-size: 100%;
font-weight: initial;
text-transform: inherit;
border-top-style: solid;
border-top-width: 2px;
border-top-color: #D3D3D3;
border-bottom-style: solid;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
border-left-style: none;
border-left-width: 1px;
border-left-color: #D3D3D3;
border-right-style: none;
border-right-width: 1px;
border-right-color: #D3D3D3;
vertical-align: middle;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_empty_group_heading {
padding: 0.5px;
color: #333333;
background-color: #FFFFFF;
font-size: 100%;
font-weight: initial;
border-top-style: solid;
border-top-width: 2px;
border-top-color: #D3D3D3;
border-bottom-style: solid;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
vertical-align: middle;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_from_md &amp;gt; :first-child {
margin-top: 0;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_from_md &amp;gt; :last-child {
margin-bottom: 0;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_row {
padding-top: 8px;
padding-bottom: 8px;
padding-left: 5px;
padding-right: 5px;
margin: 10px;
border-top-style: solid;
border-top-width: 1px;
border-top-color: #D3D3D3;
border-left-style: none;
border-left-width: 1px;
border-left-color: #D3D3D3;
border-right-style: none;
border-right-width: 1px;
border-right-color: #D3D3D3;
vertical-align: middle;
overflow-x: hidden;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_stub {
color: #333333;
background-color: #FFFFFF;
font-size: 100%;
font-weight: initial;
text-transform: inherit;
border-right-style: solid;
border-right-width: 2px;
border-right-color: #D3D3D3;
padding-left: 5px;
padding-right: 5px;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_stub_row_group {
color: #333333;
background-color: #FFFFFF;
font-size: 100%;
font-weight: initial;
text-transform: inherit;
border-right-style: solid;
border-right-width: 2px;
border-right-color: #D3D3D3;
padding-left: 5px;
padding-right: 5px;
vertical-align: top;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_row_group_first td {
border-top-width: 2px;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_summary_row {
color: #333333;
background-color: #FFFFFF;
text-transform: inherit;
padding-top: 8px;
padding-bottom: 8px;
padding-left: 5px;
padding-right: 5px;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_first_summary_row {
border-top-style: solid;
border-top-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_first_summary_row.thick {
border-top-width: 2px;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_last_summary_row {
padding-top: 8px;
padding-bottom: 8px;
padding-left: 5px;
padding-right: 5px;
border-bottom-style: solid;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_grand_summary_row {
color: #333333;
background-color: #FFFFFF;
text-transform: inherit;
padding-top: 8px;
padding-bottom: 8px;
padding-left: 5px;
padding-right: 5px;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_first_grand_summary_row {
padding-top: 8px;
padding-bottom: 8px;
padding-left: 5px;
padding-right: 5px;
border-top-style: double;
border-top-width: 6px;
border-top-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_striped {
background-color: rgba(128, 128, 128, 0.05);
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_table_body {
border-top-style: solid;
border-top-width: 2px;
border-top-color: #D3D3D3;
border-bottom-style: solid;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_footnotes {
color: #333333;
background-color: #FFFFFF;
border-bottom-style: none;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
border-left-style: none;
border-left-width: 2px;
border-left-color: #D3D3D3;
border-right-style: none;
border-right-width: 2px;
border-right-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_footnote {
margin: 0px;
font-size: 90%;
padding-left: 4px;
padding-right: 4px;
padding-left: 5px;
padding-right: 5px;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_sourcenotes {
color: #333333;
background-color: #FFFFFF;
border-bottom-style: none;
border-bottom-width: 2px;
border-bottom-color: #D3D3D3;
border-left-style: none;
border-left-width: 2px;
border-left-color: #D3D3D3;
border-right-style: none;
border-right-width: 2px;
border-right-color: #D3D3D3;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_sourcenote {
font-size: 90%;
padding-top: 4px;
padding-bottom: 4px;
padding-left: 5px;
padding-right: 5px;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_left {
text-align: left;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_center {
text-align: center;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_right {
text-align: right;
font-variant-numeric: tabular-nums;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_font_normal {
font-weight: normal;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_font_bold {
font-weight: bold;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_font_italic {
font-style: italic;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_super {
font-size: 65%;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_footnote_marks {
font-style: italic;
font-weight: normal;
font-size: 75%;
vertical-align: 0.4em;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_asterisk {
font-size: 100%;
vertical-align: 0;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_slash_mark {
font-size: 0.7em;
line-height: 0.7em;
vertical-align: 0.15em;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_fraction_numerator {
font-size: 0.6em;
line-height: 0.6em;
vertical-align: 0.45em;
}&lt;/p&gt;
&lt;p&gt;#zpafsdmqom .gt_fraction_denominator {
font-size: 0.6em;
line-height: 0.6em;
vertical-align: -0.05em;
}
&lt;/style&gt;&lt;/p&gt;
&lt;table class=&#34;gt_table&#34;&gt;
  &lt;thead class=&#34;gt_col_headings&#34;&gt;
    &lt;tr&gt;
      &lt;th class=&#34;gt_col_heading gt_columns_bottom_border gt_left&#34; rowspan=&#34;1&#34; colspan=&#34;1&#34;&gt;model&lt;/th&gt;
      &lt;th class=&#34;gt_col_heading gt_columns_bottom_border gt_right&#34; rowspan=&#34;1&#34; colspan=&#34;1&#34;&gt;mape&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody class=&#34;gt_table_body&#34;&gt;
    &lt;tr&gt;&lt;td class=&#34;gt_row gt_left&#34;&gt;cond_rnn_h1&lt;/td&gt;
&lt;td class=&#34;gt_row gt_right&#34;&gt;34.32918&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td class=&#34;gt_row gt_left&#34;&gt;cond_rnn_h7&lt;/td&gt;
&lt;td class=&#34;gt_row gt_right&#34;&gt;31.92488&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td class=&#34;gt_row gt_left&#34;&gt;simple_rnn_h1&lt;/td&gt;
&lt;td class=&#34;gt_row gt_right&#34;&gt;34.44923&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td class=&#34;gt_row gt_left&#34;&gt;simple_rnn_h7&lt;/td&gt;
&lt;td class=&#34;gt_row gt_right&#34;&gt;32.86985&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;td class=&#34;gt_row gt_left&#34;&gt;xgboost&lt;/td&gt;
&lt;td class=&#34;gt_row gt_right&#34;&gt;14.82363&lt;/td&gt;&lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;plt &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(fcast_df) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(Date, value, col &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; model)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;theme_minimal&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;facet_wrap&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;name)

plt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;index_files/figure-markdown_strict/experiments-1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;conclusions&#34;&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;As we can see, there is technically no difference in terms of MAPE, when
we are comparing results of &lt;strong&gt;simple_rnn_h1&lt;/strong&gt; and &lt;strong&gt;cond_rnn_h1&lt;/strong&gt;.
When it comes to the RNN models with 7-day horizon, the diffrences are
also negligible.&lt;/p&gt;
&lt;p&gt;Our baseline model beats both simple and conditional RNN models. However, bear
in mind that 1-timestep horizon is not a most realistic use case in most
problems.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Time Series &amp; torch #1 - Training a network to compute moving average</title>
      <author>joachimiak.krzysztof@gmail.com (Krzysztof Joachimiak)</author>
      <link>/2020/10/03/content/post/2020-10-03-ts-and-torch-1/2020-10-03-ts-and-torch-1/</link>
      <pubDate>Sat, 03 Oct 2020 00:00:00 +0000</pubDate>
      
      <guid>/2020/10/03/content/post/2020-10-03-ts-and-torch-1/2020-10-03-ts-and-torch-1/</guid>
      <description>&lt;p&gt;&lt;a&gt;&lt;img src=&#39;/post/2020-10-03-ts-and-torch-1/torch_ts_1.png&#39; align=&#34;center&#34;/&gt;&lt;/a&gt;
In the previous year, I published &lt;a href=&#34;https://krzjoa.github.io/2019/12/28/pytorch-ts-v1.html&#34;&gt;a
post&lt;/a&gt;, which as
I hoped, was the first tutorial of the series describing how to
effectively use PyTorch in Time Series Forecasting. Recently, a new
exciting R package was submitted on CRAN. This great news was officially
announced on the &lt;a href=&#34;https://blogs.rstudio.com/ai/posts/2020-09-29-introducing-torch-for-r/&#34;&gt;RStudio AI Blog&lt;/a&gt;. Yes, you mean right - the R port of
PyTorch - called simply &lt;code&gt;torch&lt;/code&gt; came into play. This encouraged me to
reactivate my series, but in this time with both R and Pythonic
versions. I’ll begin with rewriting my previous-year post.&lt;/p&gt;
&lt;h3 id=&#34;1-getting-the-data&#34;&gt;1. Getting the data&lt;/h3&gt;
&lt;p&gt;In PyTorch version I used a Shampoo sales dataset published by Rob
Hyndman in his R package fma (a software appendix for the book
&lt;em&gt;Forecasting: Methods and Applications&lt;/em&gt;). Instead of installing
Hyndman’s lib, we’ll download the dataset from the Web. It’s because
this version is already well-foramtted and we’ll avoid additional
transformation. First of all, let’s present the &lt;code&gt;shampoo&lt;/code&gt; dataset.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(ggplot2)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(dplyr)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(data.table)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(torch)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;shampoo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;read.csv&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://raw.githubusercontent.com/jbrownlee/Datasets/master/shampoo.csv&amp;#34;&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;setDT&lt;/span&gt;(shampoo)
shampoo[, n &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;.N]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;2-simple-visualization&#34;&gt;2. Simple visualization&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;head&lt;/span&gt;(shampoo))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##    Month Sales n
## 1:  1-01 266.0 1
## 2:  1-02 145.9 2
## 3:  1-03 183.1 3
## 4:  1-04 119.3 4
## 5:  1-05 180.3 5
## 6:  1-06 168.5 6
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(shampoo) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; n, y &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; Sales)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;ggtitle&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Shampoo dataset&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;center&gt;
&lt;img src=&#34;/post/2020-10-03-ts-and-torch-1//shampoo.plot-1.png&#34; &gt;
&lt;/center&gt;
&lt;p&gt;In this plot we can see an increasing trend, but in this excercise, data
characterics make no diffeence for us.&lt;/p&gt;
&lt;h3 id=&#34;3-1-d-convolution-in-pytorch-lightning-quick-intro-or-reminder&#34;&gt;3. 1-d convolution in PyTorch: lightning-quick intro (or reminder)&lt;/h3&gt;
&lt;p&gt;In the case of univariate time series, one-dimensional convolution is a
sliding window applied over time series, an operation which consist of
multiplications and additions. It was intuitively illustrated on the gif
below.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-10-03-ts-and-torch-1//conv1d.gif&#34; width=&#34;400&#34;&gt;
&lt;p&gt;&lt;strong&gt;Source:
&lt;a href=&#34;https://blog.floydhub.com/reading-minds-with-deep-learning/&#34; class=&#34;uri&#34;&gt;&lt;a href=&#34;https://blog.floydhub.com/reading-minds-with-deep-learning/&#34;&gt;https://blog.floydhub.com/reading-minds-with-deep-learning/&lt;/a&gt;&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;/center&gt;
&lt;p&gt;As you can see, output depend on input and kernel values. Defining
proper kernel, we can apply the operation we want. For example, using a
(0.5, 0.5) kernel, it will give us a two-element moving average. To test
that, let’s do a simple experiment.&lt;/p&gt;
&lt;h3 id=&#34;4-computing-moving-average-with-datatable&#34;&gt;4. Computing moving average with &lt;code&gt;data.table&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Among its many features, &lt;code&gt;data.table&lt;/code&gt; offers a set of ‘fast’ functions
(with names prefixed with &lt;strong&gt;f&lt;/strong&gt;). One example of this great stuff is a
&lt;a href=&#34;https://rdatatable.gitlab.io/data.table/reference/froll.html&#34;&gt;&lt;strong&gt;&lt;code&gt;frollmean&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;
functions, which computes moving average. We use a standard &lt;code&gt;head&lt;/code&gt;
function as well, to limit the output. What is worth to mention is that
a &lt;strong&gt;NA&lt;/strong&gt; appeared in the first row. It’s because we can’t compute moving
avearge for the first element if we haven’t added any padding on the
beginning of the array; moreover, &lt;code&gt;frollmean&lt;/code&gt; keeps the input’s length,
so the first element has no value.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;ts &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; shampoo&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;Sales

ts &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;frollmean&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;head&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##  [1]     NA 205.95 164.50 151.20 149.80 174.40 200.15 228.15 208.65 157.85
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;5-computing-moving-average-with-torch&#34;&gt;5. Computing moving average with &lt;code&gt;torch&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Now, let’s reproduce this result using 1-dimensional convolution from
&lt;code&gt;torch&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;ts_tensor &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;torch_tensor&lt;/span&gt;(ts)&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;reshape&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let’s stop here for a moment. If you are not familiar with deep learning
frameworks, you would be quite confused because of this &lt;code&gt;reshape&lt;/code&gt;
operation. What did we do above? We created a &lt;strong&gt;3-dimensional tensor&lt;/strong&gt;;
each number in &lt;code&gt;reshape&lt;/code&gt; function describes respectively:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;number of samples&lt;/li&gt;
&lt;li&gt;number of channels&lt;/li&gt;
&lt;li&gt;length of time series&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Meaning of this values requires some explanation.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Number of samples&lt;/strong&gt; is the number of time series we are working
on. As we want to perform computations for one time series only, the
value must equal one.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Number of channels&lt;/strong&gt; is is the number of &lt;strong&gt;features&lt;/strong&gt; or
(independent) &lt;strong&gt;variables&lt;/strong&gt;. We don’t have any parallel variables
containing information about, say, temperature or population. It’s
clear that this value must equal one too.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Length of time series&lt;/strong&gt;. Accordingly to &lt;code&gt;torch&lt;/code&gt; tensor reshaping
convention, minus one means &lt;em&gt;infer value for this dimension&lt;/em&gt;. If
one-dimensional time series length has 36 elements, after reshaping
it to three-dimensional tensor with &lt;em&gt;number_of_samples&lt;/em&gt; = 1 and
&lt;em&gt;number_of_channels&lt;/em&gt; = 1, the last value will be equal to 36.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;We have to do the same with the kernel.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;kernel &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;)
kernel_tensor &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;torch_tensor&lt;/span&gt;(kernel)&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;reshape&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;))
&lt;span style=&#34;color:#a6e22e&#34;&gt;torch_conv1d&lt;/span&gt;(ts_tensor, kernel_tensor)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## torch_tensor 
## (1,.,.) = 
##  Columns 1 to 7  205.9500  164.5000  151.2000  149.8000  174.4000  200.1500  228.1500
## 
## Columns 8 to 14  208.6500  157.8500  229.7000  261.2000  190.1000  171.9000  179.8000
## 
## Columns 15 to 21  241.7000  232.3500  239.2000  256.5000  264.8000  296.7500  355.7500
## 
## Columns 22 to 28  343.0500  303.4000  341.0000  390.0500  378.1500  377.6000  420.3000
## 
## Columns 29 to 35  419.3500  506.4500  491.5500  544.8000  578.6500  528.3000  614.1000
## [ CPUFloatType{1,1,35} ]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As we can observe, the result is identical with values returned by
&lt;code&gt;frollmean&lt;/code&gt; function. The only difference is lack of &lt;strong&gt;NA&lt;/strong&gt; on the
beginning.&lt;/p&gt;
&lt;h3 id=&#34;6-learning-a-network-which-computes-moving-average&#34;&gt;6. Learning a network, which computes moving average&lt;/h3&gt;
&lt;p&gt;Now, let’s get to the point and train the network on the fully
controllable example. I’ve called in this manner to distinguish it from
the real-life ones. In most cases, when we train a machine learning
model, we don’t know the optimal parameter values. We are just trying to
choose the best ones, but have no guarantee that they are globally
optimal. Here, the optimal kernel value is known and should equal
&lt;strong&gt;[0.2, 0.2, 0.2, 0.2, 0.2]&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;X_tensor &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  &lt;span style=&#34;color:#a6e22e&#34;&gt;torch_tensor&lt;/span&gt;(ts)&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;reshape&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In the step below, we are preparing &lt;strong&gt;targets&lt;/strong&gt; (&lt;strong&gt;labels&lt;/strong&gt;), which
equals to the five-element moving average.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;y &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;frollmean&lt;/span&gt;(ts, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)
y &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; y[&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;)]
y_tensor &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  &lt;span style=&#34;color:#a6e22e&#34;&gt;torch_tensor&lt;/span&gt;(y)&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;reshape&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;))
y_tensor
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## torch_tensor 
## (1,.,.) = 
##  Columns 1 to 7  178.9200  159.4200  176.6000  184.8800  199.5800  188.1000  221.7000
## 
## Columns 8 to 14  212.5200  206.4800  197.8200  215.2600  202.6200  203.7200  222.2600
## 
## Columns 15 to 21  237.5600  256.2600  259.5800  305.6200  301.1200  324.3800  331.6000
## 
## Columns 22 to 28  361.7000  340.5600  375.5200  387.3200  406.8600  433.8800  452.2200
## 
## Columns 29 to 32  500.7600  515.5600  544.3400  558.6200
## [ CPUFloatType{1,1,32} ]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We are building a one-layer convolutional neural network. It’s good to
highlight, that &lt;strong&gt;we don’t use any nonlinear activation function&lt;/strong&gt;. Last
numerical value describes the length of the kernel, &lt;em&gt;padding = 0&lt;/em&gt; means
that we don’t add any padding to the input, so we have to expect that
output will be “trimmed”.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;net &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;nn_conv1d&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, padding &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, bias &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Kernel is already initialized with, assume it for simplicity, &lt;em&gt;random&lt;/em&gt;
values.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;net&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;parameters&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## torch_tensor 
## (1,.,.) = 
##  -0.0298  0.1094 -0.4210 -0.1510 -0.1525
## [ CPUFloatType{1,1,5} ]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can perform a convolution operation using this random value, calling
&lt;strong&gt;net$forward()&lt;/strong&gt; or simply &lt;strong&gt;net()&lt;/strong&gt;. This two operations are
equivalent.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;net&lt;/span&gt;(X_tensor)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## torch_tensor 
## (1,.,.) = 
##  Columns 1 to 7 -114.5778  -87.4777 -129.1170 -124.0212 -147.8481 -122.0550 -133.4026
## 
## Columns 8 to 14 -116.5216 -191.6899  -97.2734 -126.1265 -120.6398 -148.3641 -169.2148
## 
## Columns 15 to 21 -134.7664 -188.4784 -159.5273 -219.7331 -199.5979 -246.9963 -177.3924
## 
## Columns 22 to 28 -246.2201 -228.1574 -273.1713 -222.5049 -290.8464 -284.1429 -302.4402
## 
## Columns 29 to 32 -371.9796 -297.1908 -420.1493 -324.1110
## [ CPUFloatType{1,1,32} ]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We are initializing an optimizer object. I highly encourage you to
experiment and start with &lt;strong&gt;SGD&lt;/strong&gt; which may do not converge.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# optimizer &amp;lt;- optim_sgd(net$parameters, lr = 0.01)&lt;/span&gt;
optimizer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;optim_adam&lt;/span&gt;(net&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;parameters, lr &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.01&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here, he have only one example so it does not make sense to divide
training into epochs.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;running_loss &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;0.0&lt;/span&gt;

&lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(iteration in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2000&lt;/span&gt;) {
  
    &lt;span style=&#34;color:#75715e&#34;&gt;# Zeroing gradients. For more,&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;# see: https://stackoverflow.com/questions/48001598/why-do-we-need-to-call-zero-grad-in-pytorch&lt;/span&gt;
    optimizer&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;zero_grad&lt;/span&gt;()

    &lt;span style=&#34;color:#75715e&#34;&gt;# Forward propagation&lt;/span&gt;
    outputs &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  &lt;span style=&#34;color:#a6e22e&#34;&gt;net&lt;/span&gt;(X_tensor)  

    &lt;span style=&#34;color:#75715e&#34;&gt;# Mean squared error&lt;/span&gt;
    loss_value &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;torch_mean&lt;/span&gt;((outputs &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; y_tensor)&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)

    &lt;span style=&#34;color:#75715e&#34;&gt;# Computing gradients&lt;/span&gt;
    loss_value&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;backward&lt;/span&gt;()

    &lt;span style=&#34;color:#75715e&#34;&gt;# Changing network parameters with optimizer&lt;/span&gt;
    optimizer&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;step&lt;/span&gt;()

    &lt;span style=&#34;color:#75715e&#34;&gt;# Extracting loss value from tensor&lt;/span&gt;
    running_loss &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  running_loss &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; loss_value&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;item&lt;/span&gt;()
    
    flat_weights &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; net&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;parameters&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
      &lt;span style=&#34;color:#a6e22e&#34;&gt;as_array&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
      &lt;span style=&#34;color:#a6e22e&#34;&gt;as.vector&lt;/span&gt;()
    
    &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(iteration &lt;span style=&#34;color:#f92672&#34;&gt;%%&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;) {
      &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(glue&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;glue&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[{iteration}] loss: {loss_value$item()}&amp;#34;&lt;/span&gt;))
      &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(flat_weights)
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [50] loss: 795.017639160156
## [1]  0.3119572  0.4480094 -0.0774434  0.1887493  0.1892590
## [100] loss: 627.464172363281
## [1]  0.30481237  0.42822435 -0.07718747  0.17363353  0.18184586
## [150] loss: 546.570983886719
## [1]  0.3097025  0.4179998 -0.0630119  0.1692921  0.1865403
## [200] loss: 471.807800292969
## [1]  0.31258762  0.40443128 -0.04937108  0.16256894  0.18939941
## [250] loss: 401.237457275391
## [1]  0.31531987  0.39036036 -0.03479132  0.15607581  0.19235790
## [300] loss: 337.717254638672
## [1]  0.31756479  0.37616777 -0.01987797  0.15002672  0.19514479
## [350] loss: 282.553039550781
## [1]  0.319161922  0.362225264 -0.005009139  0.144656733  0.197645336
## [400] loss: 235.910583496094
## [1] 0.320012957 0.348812759 0.009538475 0.140130043 0.199790746
## [450] loss: 197.225311279297
## [1] 0.32006672 0.33612481 0.02356522 0.13654210 0.20154381
## [500] loss: 165.532333374023
## [1] 0.31931198 0.32428458 0.03693568 0.13392988 0.20289351
## [550] loss: 139.712768554688
## [1] 0.31777066 0.31335631 0.04956749 0.13228267 0.20385022
## [600] loss: 118.661178588867
## [1] 0.31549129 0.30335727 0.06142059 0.13155238 0.20444071
## [650] loss: 101.386795043945
## [1] 0.31254151 0.29426861 0.07248778 0.13166353 0.20470326
## [700] loss: 87.0595397949219
## [1] 0.30900255 0.28604546 0.08278601 0.13252223 0.20468384
## [750] loss: 75.020133972168
## [1] 0.30496314 0.27862594 0.09234858 0.13402404 0.20443186
## [800] loss: 64.7659072875977
## [1] 0.3005151 0.2719381 0.1012190 0.1360608 0.2039973
## [850] loss: 55.9260444641113
## [1] 0.2957492 0.2659062 0.1094460 0.1385261 0.2034285
## [900] loss: 48.2335586547852
## [1] 0.2907525 0.2604553 0.1170791 0.1413187 0.2027697
## [950] loss: 41.4970893859863
## [1] 0.2856061 0.2555139 0.1241664 0.1443462 0.2020606
## [1000] loss: 35.5792236328125
## [1] 0.2803833 0.2510171 0.1307523 0.1475262 0.2013350
## [1050] loss: 30.3781261444092
## [1] 0.2751493 0.2469072 0.1368768 0.1507875 0.2006208
## [1100] loss: 25.8145942687988
## [1] 0.2699609 0.2431345 0.1425748 0.1540700 0.1999404
## [1150] loss: 21.8240375518799
## [1] 0.2648661 0.2396567 0.1478763 0.1573242 0.1993102
## [1200] loss: 18.3501605987549
## [1] 0.2599051 0.2364388 0.1528070 0.1605106 0.1987420
## [1250] loss: 15.3419895172119
## [1] 0.2551105 0.2334520 0.1573887 0.1635987 0.1982433
## [1300] loss: 12.7523593902588
## [1] 0.2505079 0.2306734 0.1616401 0.1665655 0.1978179
## [1350] loss: 10.5367918014526
## [1] 0.2461172 0.2280841 0.1655775 0.1693947 0.1974661
## [1400] loss: 8.65341949462891
## [1] 0.2419526 0.2256693 0.1692155 0.1720755 0.1971868
## [1450] loss: 7.06301403045654
## [1] 0.2380237 0.2234169 0.1725675 0.1746014 0.1969763
## [1500] loss: 5.72896862030029
## [1] 0.2343363 0.2213169 0.1756462 0.1769695 0.1968299
## [1550] loss: 4.61755132675171
## [1] 0.2308923 0.2193609 0.1784641 0.1791797 0.1967420
## [1600] loss: 3.69792985916138
## [1] 0.2276909 0.2175417 0.1810337 0.1812342 0.1967065
## [1650] loss: 2.94231581687927
## [1] 0.2247288 0.2158528 0.1833675 0.1831365 0.1967170
## [1700] loss: 2.32577872276306
## [1] 0.2220005 0.2142882 0.1854781 0.1848916 0.1967671
## [1750] loss: 1.82624590396881
## [1] 0.2194988 0.2128422 0.1873784 0.1865052 0.1968507
## [1800] loss: 1.42442286014557
## [1] 0.2172151 0.2115093 0.1890816 0.1879836 0.1969618
## [1850] loss: 1.10348606109619
## [1] 0.2151396 0.2102839 0.1906009 0.1893335 0.1970950
## [1900] loss: 0.849016129970551
## [1] 0.2132619 0.2091608 0.1919495 0.1905621 0.1972449
## [1950] loss: 0.648723244667053
## [1] 0.2115705 0.2081344 0.1931406 0.1916765 0.1974071
## [2000] loss: 0.492226451635361
## [1] 0.2100540 0.2071995 0.1941869 0.1926837 0.1975773
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As we can see in this example, algorithm converges and parameter values
are becoming close to the &lt;strong&gt;true solution&lt;/strong&gt;, i.e. &lt;strong&gt;[0.2, 0.2, 0.2,
0.2, 0.2]&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;On my blog, you can also find a &lt;a href=&#34;https://krzjoa.github.io/2019/12/28/pytorch-ts-v1.html&#34;&gt;Python
version&lt;/a&gt; of this
post.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>S4 vs vctrs library - A Double Dispatch Comparision Remake</title>
      <author>joachimiak.krzysztof@gmail.com (Krzysztof Joachimiak)</author>
      <link>/2020/10/01/content/post/2020-10-01-s4_vs_vctrs_remake/2020-10-01-s4_vs_vctrs_remake/</link>
      <pubDate>Thu, 01 Oct 2020 00:00:00 +0000</pubDate>
      
      <guid>/2020/10/01/content/post/2020-10-01-s4_vs_vctrs_remake/2020-10-01-s4_vs_vctrs_remake/</guid>
      <description>&lt;p&gt;&lt;a&gt;&lt;img src=&#39;/post/2020-10-01-s4_vs_vctrs_remake/S4_vs_vctrs_remake.jpg&#39; align=&#34;center&#34;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;remake&#34;&gt;Remake&lt;/h2&gt;
&lt;p&gt;About two weeks ago, I published on my blog a &lt;a href=&#34;https://krzjoa.github.io/2020/09/21/s4-vs-vctrs.html&#34;&gt;&lt;strong&gt;comparision between two
possible implementation of
double-dispatch&lt;/strong&gt;&lt;/a&gt;:
S4-based and vctrs-based. It turned out, that in my trials &lt;strong&gt;vctrs&lt;/strong&gt;
performed better. However, two days later I’ve got a message from
&lt;a href=&#34;https://github.com/lionel-&#34;&gt;&lt;strong&gt;Lionel Henry&lt;/strong&gt;&lt;/a&gt; via comment to my commit
on GitHub. He suggested, that S4 got faster in the newest versions of R.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&#39;/post/2020-10-01-s4_vs_vctrs_remake/lionels_comment.png&#39; align=&#34;center&#34;/&gt;
&lt;/center&gt;
&lt;p&gt;I decided to remake this experiment and check out, if my findings are
still true.&lt;/p&gt;
&lt;h2 id=&#34;why-do-we-may-need-double-dispatch&#34;&gt;Why do we may need double dispatch?&lt;/h2&gt;
&lt;p&gt;In most cases, when writing R scripts or even creating R packages, it is
enough to use standard functions or S3 methods. However, there is one
important field that forces us to consider &lt;strong&gt;double dispatch&lt;/strong&gt; question:
&lt;strong&gt;arithmetic operators&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Suppose we’d like to create a class, which fits the problem we’re
currently working on. Let’s name such class &lt;strong&gt;beer&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(type){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;structure&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; type),class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;beer&amp;#34;&lt;/span&gt;)
}

opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;structure&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opener&amp;#34;&lt;/span&gt;)
}

pilsner &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;beer&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;pilnser&amp;#34;&lt;/span&gt;)
my_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;opener&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then, we create an operator which defines some non-standard behaviour.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;if we add an opener to the beer, we get an &lt;strong&gt;opened_beer&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;adding a &lt;strong&gt;numeric&lt;/strong&gt; &lt;em&gt;x&lt;/em&gt;, we get a case of beers (which even contain
a negative number of bees, i.e. our debt…)&lt;/li&gt;
&lt;li&gt;if second argument is different than a or &lt;strong&gt;opener&lt;/strong&gt; or &lt;strong&gt;numeric&lt;/strong&gt;,
we get… untouched beer&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let’s demonstrate, how does it work:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;`+.beer` &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(a, b){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(b, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opener&amp;#34;&lt;/span&gt;)) {
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;structure&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(
          name  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened&amp;#34;&lt;/span&gt;, a&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;name)
    ), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened_beer&amp;#34;&lt;/span&gt;))
  } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(b, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;It&amp;#39;s magic! You&amp;#39;ve got a case of beers!&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;structure&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(
        n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; b
    ), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;case_of_beers&amp;#34;&lt;/span&gt;))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(a)
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; my_opener
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## $name
## [1] &amp;quot;opened &amp;quot;
## 
## attr(,&amp;quot;class&amp;quot;)
## [1] &amp;quot;opened_beer&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;-0.1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;It&#39;s magic! You&#39;ve got a case of beers!&amp;quot;

## $n_beers
## [1] 0.9
## 
## attr(,&amp;quot;class&amp;quot;)
## [1] &amp;quot;case_of_beers&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Don’t you think, that such operations should be &lt;strong&gt;commutative&lt;/strong&gt;?&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;my_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## list()
## attr(,&amp;quot;class&amp;quot;)
## [1] &amp;quot;opener&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What did happen here? This is an example of the way the R interpreter
handles arithmetic operator. It was described with details on &lt;a href=&#34;https://yutani.rbind.io/post/double-dispatch-of-s3-method/&#34;&gt;&lt;strong&gt;Hiroaki
Yutani’s
blog&lt;/strong&gt;&lt;/a&gt;.
Briefly speaking, in this particular case R engine matched method to the
second argument (not to the first one), because there is no &lt;code&gt;+.opener&lt;/code&gt;
S3 method. What about such trick:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;`+.opener` &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(a, b) b &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; a
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;After that, the result is different:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;my_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## Warning: Incompatible methods (&amp;quot;+.opener&amp;quot;, &amp;quot;+.beer&amp;quot;) for &amp;quot;+&amp;quot;

## Error in my_opener + pilsner: non-numeric argument to binary operator
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We crashed our function call. When both objects have the &lt;code&gt;+&lt;/code&gt; method
defined and these methods are not the same, R is trying to resolve the
conflict by applying an internal &lt;code&gt;+&lt;/code&gt;. It obviously cannot work. This
case could be easily solved using more ‘ifs’ in the &lt;code&gt;+.beer&lt;/code&gt; beer
function body. But let’s face a different situation.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] -0.1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What a mess! Simple S3 methods are definitely not the best solution when
we need the double dispatch.&lt;/p&gt;
&lt;h2 id=&#34;s4-class-a-classic-approach&#34;&gt;S4 class: a classic approach&lt;/h2&gt;
&lt;p&gt;To civilize such code, we can use classic R approach, S4 methods. We’ll
start from S4 classes declaration.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;.S4_beer          &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setClass&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;representation&lt;/span&gt;(type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;character&amp;#34;&lt;/span&gt;))
.S4_opened_beer   &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setClass&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opened_beer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;representation&lt;/span&gt;(type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;character&amp;#34;&lt;/span&gt;))
.S4_opener        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setClass&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;representation&lt;/span&gt;(ID &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;))
.S4_case_of_beers &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setClass&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_case_of_beers&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;representation&lt;/span&gt;(n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then, we can two otptions, how to handle &lt;code&gt;+&lt;/code&gt; operators. I didn’t mention
about it in the previous example, but both S3 and S4 operators are
grouped as so-called &lt;strong&gt;group generic functions&lt;/strong&gt; (learn more:
&lt;a href=&#34;https://stat.ethz.ch/R-manual/R-devel/library/base/html/groupGeneric.html&#34;&gt;&lt;strong&gt;S3&lt;/strong&gt;&lt;/a&gt;,
&lt;a href=&#34;https://stat.ethz.ch/R-manual/R-devel/library/methods/html/S4groupGeneric.html&#34;&gt;&lt;strong&gt;S4&lt;/strong&gt;&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;We can set a S4 method for a single operator and that looks as follows:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;+&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(e1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;, e2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;),
          &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(e2, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;)) {
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_opened_beer&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened&amp;#34;&lt;/span&gt;, e1&lt;span style=&#34;color:#f92672&#34;&gt;@&lt;/span&gt;type)))
  } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(e2, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;It&amp;#39;s magic! You&amp;#39;ve got a case of beers!&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_case_of_beers&lt;/span&gt;(n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; e2))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(e1)
  }
})

&lt;span style=&#34;color:#a6e22e&#34;&gt;setMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;+&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(e1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;, e2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;),
          &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2) e2 &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; e1)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Alternatively, we can define a method for &lt;code&gt;Arith&lt;/code&gt; geneneric and check,
what method is exactly called at the moment. I decided to use the second
approach, because it’s more similar to the way the double dispatch is
implemented in the &lt;strong&gt;vctrs&lt;/strong&gt; library.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;.S4_fun &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(e2, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;)) {
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_opened_beer&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened&amp;#34;&lt;/span&gt;, e1&lt;span style=&#34;color:#f92672&#34;&gt;@&lt;/span&gt;type)))
  } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(e2, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;It&amp;#39;s magic! You&amp;#39;ve got a case of beers!&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_case_of_beers&lt;/span&gt;(n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; e2))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(e1)
  }
}

&lt;span style=&#34;color:#a6e22e&#34;&gt;setMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Arith&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(e1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;, e2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;),
          &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2)
          {
            op &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; .Generic[[1]]
            &lt;span style=&#34;color:#a6e22e&#34;&gt;switch&lt;/span&gt;(op,
                   `+`  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_fun&lt;/span&gt;(e1, e2),
                    &lt;span style=&#34;color:#a6e22e&#34;&gt;stop&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;undefined operation&amp;#34;&lt;/span&gt;)
            )
})

&lt;span style=&#34;color:#a6e22e&#34;&gt;setMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Arith&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(e1&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;, e2&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;),
          &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2)
          { 
            op &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; .Generic[[1]]
            &lt;span style=&#34;color:#a6e22e&#34;&gt;switch&lt;/span&gt;(op,
                   `+`  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; e2 &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; e1,
                    &lt;span style=&#34;color:#a6e22e&#34;&gt;stop&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;undefined operation&amp;#34;&lt;/span&gt;)
            )
})
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let’s create our class instances and do a piece of math.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;S4_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_beer&lt;/span&gt;(type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Pilsner&amp;#34;&lt;/span&gt;)
S4_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_opener&lt;/span&gt;(ID &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;S4_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_opener
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## An object of class &amp;quot;S4_opened_beer&amp;quot;
## Slot &amp;quot;type&amp;quot;:
## [1] &amp;quot;opened Pilsner&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;S4_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## An object of class &amp;quot;S4_opened_beer&amp;quot;
## Slot &amp;quot;type&amp;quot;:
## [1] &amp;quot;opened Pilsner&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Declared methods are clear, and, the most important: they work
correctly.&lt;/p&gt;
&lt;h2 id=&#34;vctrs-library-a-tidyverse-approach&#34;&gt;vctrs library: a tidyverse approach&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/r-lib/vctrs&#34;&gt;&lt;strong&gt;vctrs&lt;/strong&gt;&lt;/a&gt; is an interesting library,
thought as a remedy for a couple of R disadvantages. It delivers, among
others, a custom double-dispatch system based on well-known S3
mechanism.&lt;/p&gt;
&lt;p&gt;At the first step we declare class ‘constructors’.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(vctrs)

.vec_beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(type){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;new_vctr&lt;/span&gt;(.data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; type), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_beer&amp;#34;&lt;/span&gt;)
}

.vec_opened_beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(type){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;new_vctr&lt;/span&gt;(.data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; type), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_opened_beer&amp;#34;&lt;/span&gt;)
}

.vec_case_of_beers &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(n_beers){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;new_vctr&lt;/span&gt;(.data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(n_beers  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; n_beers), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_case_of_beers&amp;#34;&lt;/span&gt;)
}

.vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;new_vctr&lt;/span&gt;(.data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_opener&amp;#34;&lt;/span&gt;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then, we create class instances.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;vec_pilsner   &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.vec_beer&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;pilnser&amp;#34;&lt;/span&gt;)
vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.vec_opener&lt;/span&gt;()
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;class&lt;/span&gt;(vec_pilsner))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;vec_beer&amp;quot;   &amp;quot;vctrs_vctr&amp;quot; &amp;quot;list&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;class&lt;/span&gt;(vec_opener))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;vec_opener&amp;quot; &amp;quot;vctrs_vctr&amp;quot; &amp;quot;list&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At the end, we write a double-dispatched methods &lt;strong&gt;in vctrs style&lt;/strong&gt;. As
you can see,&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;.fun &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(a, b){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(b, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_opener&amp;#34;&lt;/span&gt;)) {
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.vec_opened_beer&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened&amp;#34;&lt;/span&gt;, a&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;type)))
  } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(b, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;It&amp;#39;s magic! You&amp;#39;ve got a case of beers!&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.vec_case_of_beers&lt;/span&gt;(n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; b))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(a)
  }
}

vec_arith.vec_beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(op, x, y, &lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;) {
  &lt;span style=&#34;color:#a6e22e&#34;&gt;UseMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_arith.vec_beer&amp;#34;&lt;/span&gt;, y)
}

vec_arith.vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(op, x, y, &lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;) {
  &lt;span style=&#34;color:#a6e22e&#34;&gt;UseMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_arith.vec_opener&amp;#34;&lt;/span&gt;, y)
}

vec_arith.vec_beer.vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(op, x, y, &lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;switch&lt;/span&gt;(op,
         `+` &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.fun&lt;/span&gt;(x, y),
         &lt;span style=&#34;color:#a6e22e&#34;&gt;stop_incompatible_op&lt;/span&gt;(op, x, y)
  )
}

vec_arith.vec_opener.vec_beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(op, x, y, &lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;){
  y &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; x
} 

vec_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_opener
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## &amp;lt;vec_opened_beer[1]&amp;gt;
##           type 
## opened pilnser
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## &amp;lt;vec_opened_beer[1]&amp;gt;
##           type 
## opened pilnser
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It works properly, too.&lt;/p&gt;
&lt;h2 id=&#34;benchmark&#34;&gt;Benchmark&lt;/h2&gt;
&lt;p&gt;I’ve created all the classes and methods above not only to demonstate,
how to implement double dispatch in R. My main goal is to benchmark both
approaches and check, which one has smaller overhead. The hardware I
used for the test looks as follows:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## $vendor_id
## [1] &amp;quot;GenuineIntel&amp;quot;
## 
## $model_name
## [1] &amp;quot;Intel(R) Core(TM) i3 CPU       M 350  @ 2.27GHz&amp;quot;
## 
## $no_of_cores
## [1] 4

## 8.19 GB
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sessionInfo&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## R version 4.0.2 (2020-06-22)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 18.04.2 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /opt/intel/compilers_and_libraries_2018.2.199/linux/mkl/lib/intel64_lin/libmkl_rt.so
## 
## locale:
##  [1] LC_CTYPE=pl_PL.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=pl_PL.UTF-8        LC_COLLATE=pl_PL.UTF-8    
##  [5] LC_MONETARY=pl_PL.UTF-8    LC_MESSAGES=en_US.utf8    
##  [7] LC_PAPER=pl_PL.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=pl_PL.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] vctrs_0.3.4
## 
## loaded via a namespace (and not attached):
##  [1] benchmarkmeData_1.0.4 knitr_1.30            magrittr_1.5         
##  [4] tidyselect_1.1.0      doParallel_1.0.15     lattice_0.20-41      
##  [7] R6_2.4.1              rlang_0.4.7           foreach_1.5.0        
## [10] httr_1.4.2            stringr_1.4.0         dplyr_1.0.2          
## [13] tools_4.0.2           parallel_4.0.2        grid_4.0.2           
## [16] xfun_0.18             ellipsis_0.3.1        htmltools_0.5.0      
## [19] iterators_1.0.12      yaml_2.2.1            digest_0.6.25        
## [22] tibble_3.0.3          benchmarkme_1.0.4     lifecycle_0.2.0      
## [25] crayon_1.3.4          Matrix_1.2-18         purrr_0.3.4          
## [28] codetools_0.2-16      glue_1.4.2            evaluate_0.14        
## [31] rmarkdown_2.4         stringi_1.5.3         pillar_1.4.6         
## [34] compiler_4.0.2        generics_0.0.2        pkgconfig_2.0.3
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It’s my good old notebook, which is not a beast.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(microbenchmark)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(ggplot2)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;beer--opener&#34;&gt;Beer + opener&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;bm1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;microbenchmark&lt;/span&gt;(
  s4 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; S4_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_opener,
  s3_vec &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; vec_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_opener,
  times &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;r-402&#34;&gt;R 4.0.2&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;## Unit: microseconds
##    expr     min       lq      mean  median       uq      max neval
##      s4 177.111 182.9710 197.09576 186.997 190.7615 1937.005  1000
##  s3_vec  68.568  74.3705  83.27131  82.710  84.4995  306.320  1000
&lt;/code&gt;&lt;/pre&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-10-01-s4_vs_vctrs_remake/print.results.1-1.png&#34; &gt;
&lt;/center&gt;
&lt;h4 id=&#34;r-361&#34;&gt;R 3.6.1&lt;/h4&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-10-01-s4_vs_vctrs_remake/print.results.1-1-old.png&#34; &gt;
&lt;/center&gt;
&lt;h3 id=&#34;opener--beer&#34;&gt;Opener + beer&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;bm2 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;microbenchmark&lt;/span&gt;(
  s4 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; S4_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_pilsner,
  s3_vec &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_pilsner,
  times &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;r-402-1&#34;&gt;R 4.0.2&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;## Unit: microseconds
##    expr     min       lq     mean   median       uq      max neval
##      s4 186.736 191.6060 216.6038 196.0305 200.1195 8109.925  1000
##  s3_vec  87.808  92.0705 110.3604 100.2730 102.7115 6588.121  1000
&lt;/code&gt;&lt;/pre&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-10-01-s4_vs_vctrs_remake/print.results.2-1.png&#34; &gt;
&lt;/center&gt;
&lt;h4 id=&#34;r-361-1&#34;&gt;R 3.6.1&lt;/h4&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-10-01-s4_vs_vctrs_remake/print.results.2-1-old.png&#34; &gt;
&lt;/center&gt;
&lt;h3 id=&#34;bonus-opener--beer-vs-addtion-of-numerics&#34;&gt;Bonus: opener + beer vs addtion of numerics&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;bm3 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;microbenchmark&lt;/span&gt;(
  simple_R &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,
  s4 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; S4_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_pilsner,
  s3_vec &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_pilsner,
  times &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;r-402-2&#34;&gt;R 4.0.2&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;## Unit: nanoseconds
##      expr    min       lq       mean   median       uq    max neval
##  simple_R    133    374.0    643.296    722.0    795.0   2004  1000
##        s4 185652 190964.5 206643.130 195424.0 198756.5 564443  1000
##    s3_vec  87889  92022.0 103274.276 100360.5 102306.0 234482  1000
&lt;/code&gt;&lt;/pre&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-10-01-s4_vs_vctrs_remake/print.results.3-1.png&#34; &gt;
&lt;/center&gt;
&lt;h4 id=&#34;r-361-2&#34;&gt;R 3.6.1&lt;/h4&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-10-01-s4_vs_vctrs_remake/print.results.3-1-old.png&#34; &gt;
&lt;/center&gt;
&lt;h2 id=&#34;conclusions&#34;&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;Results are roughly the same as outcomes of my previous experiments run
on R 3.6.1. We can state thar regarding these particular machine and
examples, &lt;strong&gt;vctrs-based&lt;/strong&gt; performs better than &lt;strong&gt;S4 methods&lt;/strong&gt;.&lt;/p&gt;
&lt;h2 id=&#34;further-sources&#34;&gt;Further sources&lt;/h2&gt;
&lt;p&gt;If you are interesting, how to implement double-dispatched operators in
S4, I encourage you to get familiar with code of the following R
libraries:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cran/Matrix/blob/master/R/Ops.R&#34;&gt;Matrix&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cdeterman/gpuR/blob/master/R/methods-gpuVector.R&#34;&gt;gpuR&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you are looking for some examples of &lt;strong&gt;vctrs&lt;/strong&gt;, I recommend you to
learn the source code of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/r-lib/rray/blob/master/R/compat-vctrs-arith.R&#34;&gt;rray&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/RMHogervorst/banana/blob/master/R/banana.R&#34;&gt;banana&lt;/a&gt;
(a funny toy package)&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>path.chain: Concise Structure for Chainable Paths</title>
      <author>joachimiak.krzysztof@gmail.com (Krzysztof Joachimiak)</author>
      <link>/2020/09/27/content/post/2020-09-27-path-chain/2020-09-27-path-chain/</link>
      <pubDate>Sun, 27 Sep 2020 00:00:00 +0000</pubDate>
      
      <guid>/2020/09/27/content/post/2020-09-27-path-chain/2020-09-27-path-chain/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://krzjoa.github.io/path.chain&#34;&gt;&lt;img src=&#39;https://raw.githubusercontent.com/krzjoa/path.chain/master/man/figures/logo.png&#39; align=&#34;left&#34; height=&#34;139&#34; style=&#34;margin-right: 20px&#34; /&gt;&lt;/a&gt;
&lt;code&gt;path.chain&lt;/code&gt; package provides an intuitive and easy-to-use system of
nested objects, which represents different levels of some directory’s
structure in the file system. It allows us to created a nested structure, which returns a string
from every its leaf.&lt;/p&gt;
&lt;br/&gt;
&lt;h2 id=&#34;look-at-the-pathchain&#34;&gt;Look at the &lt;code&gt;path.chain&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;Sometimes one picture can say more, than a thousand words, and this is
exactly the case.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&#39;https://raw.githubusercontent.com/krzjoa/path.chain/master/man/figures/path_chain.gif&#39;/&gt;
&lt;/center&gt;
&lt;h2 id=&#34;motivation&#34;&gt;Motivation&lt;/h2&gt;
&lt;p&gt;I’ve been working on the ML project, when we decided to keep strcture of
the input data in the &lt;strong&gt;YAML&lt;/strong&gt; config. The structure were getting
complicated, and at some point on this history ou config get a form like
this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;default&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;kData&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;kRoot&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;our/super/dir&amp;#39;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;kTerroir&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;kRoot&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;terroir&amp;#39;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;kSoils&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;soils.fst&amp;#39;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;kTemperature&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;temperature.fst&amp;#39;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;kRains&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;rains.fst&amp;#39;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;kWineQuality&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;kChemicalParams&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;chemical_params.fst&amp;#39;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;kContestResults&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;contest_results.fst&amp;#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;For your infomation: the example above is totally fictitious and has
nothing to do with the actual project I’ve been woking on. Moreover, in
our project, several times more of paths were defined. As you can
imagine, such structure forced us to load data in the following manner:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;config &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; config&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;get&lt;/span&gt;(
  config &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;default&amp;#34;&lt;/span&gt;
  file &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;path/to/config&amp;#34;&lt;/span&gt;,
  use_parent &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt;  
)

path &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;file.path&lt;/span&gt;(
  config&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kData&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kRoot,
  config&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kData&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kTerroir&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kRoot,
  config&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kData&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kTerroir&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kSoils
)

vineyard_soils &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; fst&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;read_fst&lt;/span&gt;(path)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Doesn’t it look redundant? So, I’ve written a &lt;code&gt;path.chain&lt;/code&gt; package:
using it we can perform the same action with less code:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(path.chain)

vineyard_soils &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; fst&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;read_fst&lt;/span&gt;(
  config&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kData&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kTerroir&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;kSoils
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Isn’t it nice for your eyes?&lt;/p&gt;
&lt;p&gt;If I would like to modify the config, say, with the following change,&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;default&lt;/span&gt;:
  &lt;span style=&#34;color:#f92672&#34;&gt;kData&lt;/span&gt;:
    &lt;span style=&#34;color:#f92672&#34;&gt;kRoot&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;our/super/dir&amp;#39;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;kTerroir&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;kRoot&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;terroir&amp;#39;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;kSoils&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;vineyard_soils.fst&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# &amp;lt;- This is the change&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;kTemperature&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;temperature.fst&amp;#39;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;kRains&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;rains.fst&amp;#39;&lt;/span&gt;
    &lt;span style=&#34;color:#f92672&#34;&gt;kWineQuality&lt;/span&gt;:
      &lt;span style=&#34;color:#f92672&#34;&gt;kChemicalParams&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;chemical_params.fst&amp;#39;&lt;/span&gt;
      &lt;span style=&#34;color:#f92672&#34;&gt;kContestResults&lt;/span&gt;: &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;contest_results.fst&amp;#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;the code is still working.&lt;/p&gt;
&lt;p&gt;What if we would like to reconfigure our list of paths wthout changing
the code? It may probably break desired behaviour of our scripts, but
with &lt;code&gt;path.chain&lt;/code&gt; we can easily detect the cause looking into logs.
Simply use &lt;code&gt;on_path_not_exists&lt;/code&gt; or &lt;code&gt;on_validate_path&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;on_validate_path&lt;/span&gt;(
  &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;if&lt;/span&gt;(tools&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;file_ext&lt;/span&gt;(.x) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;.fst&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Invalid file&amp;#34;&lt;/span&gt;)
)

&lt;span style=&#34;color:#a6e22e&#34;&gt;on_path_not_exists&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;log_error&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Path {.x} not exists&amp;#34;&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;To learn more, read the &lt;a href=&#34;https://krzjoa.github.io/path.chain/index.html&#34;&gt;package
documentation&lt;/a&gt;.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Double dispatch in R: S4 vs vctrs</title>
      <author>joachimiak.krzysztof@gmail.com (Krzysztof Joachimiak)</author>
      <link>/2020/09/21/content/post/2020-09-21-s4-vs-vctrs/2020-09-21-s4-vs-vctrs/</link>
      <pubDate>Mon, 21 Sep 2020 00:00:00 +0000</pubDate>
      
      <guid>/2020/09/21/content/post/2020-09-21-s4-vs-vctrs/2020-09-21-s4-vs-vctrs/</guid>
      <description>&lt;p&gt;&lt;a&gt;&lt;img src=&#39;/post/2020-09-21-s4-vs-vctrs/S4_vs_vctrs.jpg&#39; align=&#34;center&#34;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;why-do-we-may-need-double-dispatch&#34;&gt;Why do we may need double dispatch?&lt;/h2&gt;
&lt;p&gt;In most cases, when writing R scripts or even creating R packages, it is
enough to use standard functions or S3 methods. However, there is one
important field that forces us to consider &lt;strong&gt;double dispatch&lt;/strong&gt; question:
&lt;strong&gt;arithmetic operators&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Suppose we’d like to create a class, which fits the problem we’re
currently working on. Let’s name such class &lt;strong&gt;beer&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(type){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;structure&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; type),class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;beer&amp;#34;&lt;/span&gt;)
}

opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;structure&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opener&amp;#34;&lt;/span&gt;)
}

pilsner &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;beer&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;pilnser&amp;#34;&lt;/span&gt;)
my_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;opener&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then, we create an operator which defines some non-standard behaviour.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;if we add an opener to the beer, we get an &lt;strong&gt;opened_beer&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;adding a &lt;strong&gt;numeric&lt;/strong&gt; &lt;em&gt;x&lt;/em&gt;, we get a case of beers (which even contain
a negative number of bees, i.e. our owe…)&lt;/li&gt;
&lt;li&gt;if second argument is different than a or &lt;strong&gt;opener&lt;/strong&gt; or &lt;strong&gt;numeric&lt;/strong&gt;,
we get… untouched beer&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let’s demonstrate, how does it work:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;`+.beer` &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(a, b){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(b, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opener&amp;#34;&lt;/span&gt;)) {
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;structure&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(
          name  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened&amp;#34;&lt;/span&gt;, a&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;name)
    ), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened_beer&amp;#34;&lt;/span&gt;))
  } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(b, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;It&amp;#39;s magic! You&amp;#39;ve got a case of beers!&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;structure&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(
        n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; b
    ), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;case_of_beers&amp;#34;&lt;/span&gt;))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(a)
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; my_opener
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## $name
## [1] &amp;quot;opened &amp;quot;
## 
## attr(,&amp;quot;class&amp;quot;)
## [1] &amp;quot;opened_beer&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;-0.1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;It&#39;s magic! You&#39;ve got a case of beers!&amp;quot;

## $n_beers
## [1] 0.9
## 
## attr(,&amp;quot;class&amp;quot;)
## [1] &amp;quot;case_of_beers&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Don’t you think, that such operations should be &lt;strong&gt;commutative&lt;/strong&gt;?&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;my_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## list()
## attr(,&amp;quot;class&amp;quot;)
## [1] &amp;quot;opener&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What did happen here? This is an example of the way the R interpreter
handles arithmetic operator. It was described with details on &lt;a href=&#34;https://yutani.rbind.io/post/double-dispatch-of-s3-method/&#34;&gt;&lt;strong&gt;Hiroaki
Yutani’s
blog&lt;/strong&gt;&lt;/a&gt;.
Briefly speaking, in this particular case R engine matched method to the
second argument (not to the first one), because there is no &lt;code&gt;+.opener&lt;/code&gt;
S3 method. What about such trick:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;`+.opener` &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(a, b) b &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; a
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;After that, the result is different:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;my_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## Warning: Incompatible methods (&amp;quot;+.opener&amp;quot;, &amp;quot;+.beer&amp;quot;) for &amp;quot;+&amp;quot;

## Error in my_opener + pilsner: non-numeric argument to binary operator
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We crashed our function call. When both objects have the &lt;code&gt;+&lt;/code&gt; method
defined and these methods are not the same, R is trying to resolve the
conflict by applying an internal &lt;code&gt;+&lt;/code&gt;. It obviously cannot work. This
case could be easily solved using more ‘ifs’ in the &lt;code&gt;+.beer&lt;/code&gt; beer
function body. But let’s face a different situation.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] -0.1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What a mess! Simple S3 methods are definitely not the best solution when
we need the double dispatch.&lt;/p&gt;
&lt;h2 id=&#34;s4-class-a-classic-approach&#34;&gt;S4 class: a classic approach&lt;/h2&gt;
&lt;p&gt;To civilize such code, we can use classic R approach, S4 methods. We’ll
start from S4 classes declaration.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;.S4_beer          &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setClass&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;representation&lt;/span&gt;(type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;character&amp;#34;&lt;/span&gt;))
.S4_opened_beer   &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setClass&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opened_beer&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;representation&lt;/span&gt;(type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;character&amp;#34;&lt;/span&gt;))
.S4_opener        &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setClass&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;representation&lt;/span&gt;(ID &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;))
.S4_case_of_beers &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;setClass&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_case_of_beers&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;representation&lt;/span&gt;(n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then, we can two otptions, how to handle &lt;code&gt;+&lt;/code&gt; operators. I didn’t mention
about it in the previous example, but both S3 and S4 operators are
grouped as so-called &lt;strong&gt;group generic functions&lt;/strong&gt; (learn more:
&lt;a href=&#34;https://stat.ethz.ch/R-manual/R-devel/library/base/html/groupGeneric.html&#34;&gt;&lt;strong&gt;S3&lt;/strong&gt;&lt;/a&gt;,
&lt;a href=&#34;https://stat.ethz.ch/R-manual/R-devel/library/methods/html/S4groupGeneric.html&#34;&gt;&lt;strong&gt;S4&lt;/strong&gt;&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;We can set a S4 method for a single operator and that looks as follows:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;setMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;+&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(e1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;, e2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;),
          &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(e2, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;)) {
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_opened_beer&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened&amp;#34;&lt;/span&gt;, e1&lt;span style=&#34;color:#f92672&#34;&gt;@&lt;/span&gt;type)))
  } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(e2, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;It&amp;#39;s magic! You&amp;#39;ve got a case of beers!&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_case_of_beers&lt;/span&gt;(n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; e2))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(e1)
  }
})

&lt;span style=&#34;color:#a6e22e&#34;&gt;setMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;+&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(e1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;, e2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;),
          &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2) e2 &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; e1)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Alternatively, we can define a method for &lt;code&gt;Arith&lt;/code&gt; geneneric and check,
what method is exactly called at the moment. I decided to use the second
approach, because it’s more similar to the way the double dispatch is
implemented in the &lt;strong&gt;vctrs&lt;/strong&gt; library.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;.S4_fun &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(e2, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;)) {
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_opened_beer&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened&amp;#34;&lt;/span&gt;, e1&lt;span style=&#34;color:#f92672&#34;&gt;@&lt;/span&gt;type)))
  } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(e2, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;It&amp;#39;s magic! You&amp;#39;ve got a case of beers!&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_case_of_beers&lt;/span&gt;(n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; e2))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(e1)
  }
}

&lt;span style=&#34;color:#a6e22e&#34;&gt;setMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Arith&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(e1 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;, e2 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;),
          &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2)
          {
            op &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; .Generic[[1]]
            &lt;span style=&#34;color:#a6e22e&#34;&gt;switch&lt;/span&gt;(op,
                   `+`  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_fun&lt;/span&gt;(e1, e2),
                    &lt;span style=&#34;color:#a6e22e&#34;&gt;stop&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;undefined operation&amp;#34;&lt;/span&gt;)
            )
})

&lt;span style=&#34;color:#a6e22e&#34;&gt;setMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Arith&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(e1&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_opener&amp;#34;&lt;/span&gt;, e2&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S4_beer&amp;#34;&lt;/span&gt;),
          &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e1, e2)
          { 
            op &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; .Generic[[1]]
            &lt;span style=&#34;color:#a6e22e&#34;&gt;switch&lt;/span&gt;(op,
                   `+`  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; e2 &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; e1,
                    &lt;span style=&#34;color:#a6e22e&#34;&gt;stop&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;undefined operation&amp;#34;&lt;/span&gt;)
            )
})
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let’s create our class instances and do a piece of math.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;S4_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_beer&lt;/span&gt;(type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Pilsner&amp;#34;&lt;/span&gt;)
S4_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.S4_opener&lt;/span&gt;(ID &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;S4_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_opener
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## An object of class &amp;quot;S4_opened_beer&amp;quot;
## Slot &amp;quot;type&amp;quot;:
## [1] &amp;quot;opened Pilsner&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;S4_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## An object of class &amp;quot;S4_opened_beer&amp;quot;
## Slot &amp;quot;type&amp;quot;:
## [1] &amp;quot;opened Pilsner&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Declared methods are clear, and, the most important: they work
correctly.&lt;/p&gt;
&lt;h2 id=&#34;vctrs-library-a-tidyverse-approach&#34;&gt;vctrs library: a tidyverse approach&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/r-lib/vctrs&#34;&gt;&lt;strong&gt;vctrs&lt;/strong&gt;&lt;/a&gt; is an interesting library,
thought as a remedy for a couple of R disadvantages. It delivers, among
others, a custom double-dispatch system based on well-known S3
mechanism.&lt;/p&gt;
&lt;p&gt;At the first step we declare class ‘constructors’.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(vctrs)

.vec_beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(type){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;new_vctr&lt;/span&gt;(.data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; type), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_beer&amp;#34;&lt;/span&gt;)
}

.vec_opened_beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(type){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;new_vctr&lt;/span&gt;(.data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; type), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_opened_beer&amp;#34;&lt;/span&gt;)
}

.vec_case_of_beers &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(n_beers){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;new_vctr&lt;/span&gt;(.data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(n_beers  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; n_beers), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_case_of_beers&amp;#34;&lt;/span&gt;)
}

.vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;new_vctr&lt;/span&gt;(.data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(), class &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_opener&amp;#34;&lt;/span&gt;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Then, we create class instances.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;vec_pilsner   &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.vec_beer&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;pilnser&amp;#34;&lt;/span&gt;)
vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.vec_opener&lt;/span&gt;()
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;class&lt;/span&gt;(vec_pilsner))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;vec_beer&amp;quot;   &amp;quot;vctrs_vctr&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;class&lt;/span&gt;(vec_opener))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;vec_opener&amp;quot; &amp;quot;vctrs_vctr&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At the end, we write a double-dispatched methods &lt;strong&gt;in vctrs style&lt;/strong&gt;. As
you can see,&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;.fun &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(a, b){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(b, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_opener&amp;#34;&lt;/span&gt;)) {
        &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.vec_opened_beer&lt;/span&gt;(type  &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;paste&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;opened&amp;#34;&lt;/span&gt;, a&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;type)))
  } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;inherits&lt;/span&gt;(b, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;It&amp;#39;s magic! You&amp;#39;ve got a case of beers!&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;.vec_case_of_beers&lt;/span&gt;(n_beers &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; b))
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(a)
  }
}

vec_arith.vec_beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(op, x, y, &lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;) {
  &lt;span style=&#34;color:#a6e22e&#34;&gt;UseMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_arith.vec_beer&amp;#34;&lt;/span&gt;, y)
}

vec_arith.vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(op, x, y, &lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;) {
  &lt;span style=&#34;color:#a6e22e&#34;&gt;UseMethod&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;vec_arith.vec_opener&amp;#34;&lt;/span&gt;, y)
}

vec_arith.vec_beer.vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(op, x, y, &lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;switch&lt;/span&gt;(op,
         `+` &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;.fun&lt;/span&gt;(x, y),
         &lt;span style=&#34;color:#a6e22e&#34;&gt;stop_incompatible_op&lt;/span&gt;(op, x, y)
  )
}

vec_arith.vec_opener.vec_beer &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(op, x, y, &lt;span style=&#34;color:#66d9ef&#34;&gt;...&lt;/span&gt;){
  y &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; x
} 

vec_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_opener
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## &amp;lt;vec_opened_beer[1]&amp;gt;
##           type 
## opened pilnser
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_pilsner
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## &amp;lt;vec_opened_beer[1]&amp;gt;
##           type 
## opened pilnser
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It works properly, too.&lt;/p&gt;
&lt;h2 id=&#34;benchmark&#34;&gt;Benchmark&lt;/h2&gt;
&lt;p&gt;I’ve created all the classes and methods above not only to demonstate,
how to implement double dispatch in R. My main goal is to benchmark both
approaches and check, which one has smaller overhead. The hardware I
used for the test looks as follows:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## $vendor_id
## [1] &amp;quot;GenuineIntel&amp;quot;
## 
## $model_name
## [1] &amp;quot;Intel(R) Core(TM) i3 CPU       M 350  @ 2.27GHz&amp;quot;
## 
## $no_of_cores
## [1] 4

## 8.19 GB
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sessionInfo&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## R version 3.6.1 (2019-07-05)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 18.04.2 LTS
## 
## Matrix products: default
## BLAS:   /usr/local/lib/R/lib/libRblas.so
## LAPACK: /usr/local/lib/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=pl_PL.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=pl_PL.UTF-8        LC_COLLATE=pl_PL.UTF-8    
##  [5] LC_MONETARY=pl_PL.UTF-8    LC_MESSAGES=en_US.utf8    
##  [7] LC_PAPER=pl_PL.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=pl_PL.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] vctrs_0.2.3
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.3            benchmarkmeData_1.0.3 knitr_1.23           
##  [4] magrittr_1.5          tidyselect_0.2.5      doParallel_1.0.15    
##  [7] lattice_0.20-38       R6_2.4.0              rlang_0.4.2          
## [10] foreach_1.4.7         httr_1.4.1            stringr_1.4.0        
## [13] dplyr_0.8.3           tools_3.6.1           parallel_3.6.1       
## [16] grid_3.6.1            xfun_0.9              htmltools_0.3.6      
## [19] iterators_1.0.12      yaml_2.2.0            digest_0.6.25        
## [22] assertthat_0.2.1      tibble_2.1.3          benchmarkme_1.0.3    
## [25] crayon_1.3.4          Matrix_1.2-17         purrr_0.3.3          
## [28] codetools_0.2-16      glue_1.3.1            evaluate_0.14        
## [31] rmarkdown_1.14        stringi_1.4.3         pillar_1.4.2         
## [34] compiler_3.6.1        pkgconfig_2.0.2
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It’s my good old notebook, which is not a beast.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(microbenchmark)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(ggplot2)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;beer--opener&#34;&gt;Beer + opener&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;bm1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;microbenchmark&lt;/span&gt;(
  s4 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; S4_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_opener,
  s3_vec &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; vec_pilsner &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_opener,
  times &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## Unit: microseconds
##    expr     min       lq      mean   median       uq      max neval
##      s4 153.292 158.2120 178.40541 161.4225 165.6375 5506.681  1000
##  s3_vec  56.686  60.1265  69.52364  68.9240  70.8830  163.278  1000
&lt;/code&gt;&lt;/pre&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-09-21-s4-vs-vctrs/print.results.1-1.png&#34; &gt;
&lt;/center&gt;
&lt;h3 id=&#34;opener--beer&#34;&gt;Opener + beer&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;bm2 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;microbenchmark&lt;/span&gt;(
  s4 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; S4_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_pilsner,
  s3_vec &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_pilsner,
  times &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## Unit: microseconds
##    expr     min       lq      mean   median       uq      max neval
##      s4 159.512 164.6735 191.74781 168.9655 176.3165 6068.477  1000
##  s3_vec  71.110  78.5835  96.22535  86.6720  89.4015 4796.377  1000
&lt;/code&gt;&lt;/pre&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-09-21-s4-vs-vctrs/print.results.2-1.png&#34; &gt;
&lt;/center&gt;
&lt;h3 id=&#34;bonus-opener--beer-vs-addtion-of-numerics&#34;&gt;Bonus: opener + beer vs addtion of numerics&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;bm3 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;microbenchmark&lt;/span&gt;(
  simple_R &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,
  s4 &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; S4_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; S4_pilsner,
  s3_vec &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; vec_opener &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; vec_pilsner,
  times &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## Unit: nanoseconds
##      expr    min       lq      mean   median     uq    max neval
##  simple_R    130    344.0    697.49    744.5    857   2862  1000
##        s4 158769 164522.5 189297.35 169270.5 198120 375648  1000
##    s3_vec  74775  78395.5  94786.28  87192.5  94085 258129  1000
&lt;/code&gt;&lt;/pre&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2020-09-21-s4-vs-vctrs/print.results.3-1.png&#34; &gt;
&lt;/center&gt;
&lt;h2 id=&#34;conclusions&#34;&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;It seems that &lt;strong&gt;vctrs-based&lt;/strong&gt; performs better than traditional &lt;strong&gt;S4
methods&lt;/strong&gt;. Obviously, I checked only one operation and probably some
edge cases may exists. However, I think that it shows us some direction,
what execution time we can expect.&lt;/p&gt;
&lt;h2 id=&#34;further-sources&#34;&gt;Further sources&lt;/h2&gt;
&lt;p&gt;If you are interesting, how to implement double-dispatched operators in
S4, I encourage you to get familiar with code of the following R
libraries:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cran/Matrix/blob/master/R/Ops.R&#34;&gt;Matrix&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/cdeterman/gpuR/blob/master/R/methods-gpuVector.R&#34;&gt;gpuR&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you are looking for some examples of &lt;strong&gt;vctrs&lt;/strong&gt;, I recommend you to
learn the source code of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/r-lib/rray/blob/master/R/compat-vctrs-arith.R&#34;&gt;rray&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/RMHogervorst/banana/blob/master/R/banana.R&#34;&gt;banana&lt;/a&gt;
(a funny toy package)&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>eponge: Keep Your Environment Clean</title>
      <author>joachimiak.krzysztof@gmail.com (Krzysztof Joachimiak)</author>
      <link>/2020/05/10/content/post/2020-05-10-eponge/2020-05-10-eponge/</link>
      <pubDate>Sun, 10 May 2020 00:00:00 +0000</pubDate>
      
      <guid>/2020/05/10/content/post/2020-05-10-eponge/2020-05-10-eponge/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://krzjoa.github.io/matricks&#34;&gt;&lt;img src=&#39;https://raw.githubusercontent.com/krzjoa/eponge/master/man/figures/logo.png&#39; align=&#34;left&#34; height=&#34;139&#34; style=&#34;margin-right: 20px&#34; /&gt;&lt;/a&gt;
&lt;code&gt;eponge&lt;/code&gt; is a small package, which facilitates selective object removal.
It was released on
&lt;a href=&#34;https://cran.r-project.org/web/packages/eponge/index.html&#34;&gt;CRAN&lt;/a&gt; at
23th March 2020. Initially, the package was named &lt;code&gt;sponge&lt;/code&gt;, but during
first submission trial I found out, that currently there exists the
&lt;a href=&#34;https://www.bioconductor.org/packages/release/bioc/html/SPONGE.html&#34;&gt;SPONGE&lt;/a&gt;
package, availbale on BioConductor. Because of that, I decided to rename
my package, changing only one letter. The package was given a new name:
&lt;code&gt;eponge&lt;/code&gt;, which simply means &lt;em&gt;sponge&lt;/em&gt; in
&lt;a href=&#34;https://en.wiktionary.org/wiki/%C3%A9ponge&#34;&gt;French&lt;/a&gt;. Let me present,
what the package was created for.&lt;/p&gt;
&lt;h2 id=&#34;removing-objects-by-name&#34;&gt;Removing objects by name&lt;/h2&gt;
&lt;p&gt;Typically, when we want to remove all objects from the &lt;strong&gt;global
environment&lt;/strong&gt;, we can use click the broom icon in RStudio (supposing we
use this IDE - but in most cases, we do). Alternatively, we can obtain
the same results combining &lt;code&gt;rm&lt;/code&gt; with &lt;code&gt;ls&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Remove all the objects&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;rm&lt;/span&gt;(list &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ls&lt;/span&gt;())
&lt;span style=&#34;color:#75715e&#34;&gt;# Remove object with &amp;#39;iris&amp;#39; in its name&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;rm&lt;/span&gt;(list &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ls&lt;/span&gt;(pattern &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iris&amp;#34;&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;eponge&lt;/code&gt; offers a an equivalent shortcut: &lt;code&gt;erase&lt;/code&gt; function. It’s
particularly handy when we want to select some set of objects using
regex pattern.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Remove all the objects&lt;/span&gt;
eponge&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;erase&lt;/span&gt;() 
&lt;span style=&#34;color:#75715e&#34;&gt;# Remove object with &amp;#39;iris&amp;#39; in its name&lt;/span&gt;
eponge&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;erase&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;iris&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;removing-objects-by-type&#34;&gt;Removing objects by type&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;epnoge&lt;/code&gt; becomes even more useful, when we want to precisely remove a
tiny subset of objects. Normally, we would use a combination of &lt;code&gt;ls&lt;/code&gt;,
&lt;code&gt;get&lt;/code&gt; and &lt;code&gt;rm&lt;/code&gt; functions. If we don’t want to recreate such code from
scratch, &lt;code&gt;eponge&lt;/code&gt; do it for us:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Erasing by type&lt;/span&gt;
eponge&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;erase_if&lt;/span&gt;(is.character)
&lt;span style=&#34;color:#75715e&#34;&gt;# We can use a regex pattern to identify the objects we want&lt;/span&gt;
eponge&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;erase_functions&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;prepare_&amp;#34;&lt;/span&gt;)
&lt;span style=&#34;color:#75715e&#34;&gt;# We can clean whole section in RStudio Envitonment tab&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# Remove all the objects named in RStudio as &amp;#34;Data&amp;#34;&lt;/span&gt;
eponge&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;erase_data&lt;/span&gt;()
&lt;span style=&#34;color:#75715e&#34;&gt;# Remove all the &amp;#34;Values&amp;#34; in RStidio&lt;/span&gt;
eponge&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;erase_values&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;removing-masking-objects&#34;&gt;Removing masking objects&lt;/h2&gt;
&lt;p&gt;As we know, homonime objects mask each other. If we want to get rid of
such objects from our environment, the most convenient way to do that is
&lt;code&gt;eponge&lt;/code&gt;’s &lt;code&gt;erase_masking_*&lt;/code&gt; function family. At the moment, it embraces
two functions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;erase_masking&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;erase_masking_functions&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;log &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x) &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;paste0&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Logging:&amp;#34;&lt;/span&gt;, x))
cars &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(idx   &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;,
                   speed &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;runif&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;30&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;))
eponge&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;erase_masking&lt;/span&gt;()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;eponge&lt;/code&gt; allows you to keep your R environments clean in easy way. Try
it yourself!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>matricks 0.8.2 available on CRAN</title>
      <author>joachimiak.krzysztof@gmail.com (Krzysztof Joachimiak)</author>
      <link>/2020/02/29/content/post/2020-02-29-matricks-release/2020-02-29-matricks-release/</link>
      <pubDate>Sat, 29 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>/2020/02/29/content/post/2020-02-29-matricks-release/2020-02-29-matricks-release/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://krzjoa.github.io/matricks&#34;&gt;&lt;img src=&#39;https://raw.githubusercontent.com/krzjoa/matricks/master/man/figures/logo.png&#39; align=&#34;left&#34; height=&#34;139&#34; style=&#34;margin-right: 20px&#34; /&gt;&lt;/a&gt;
&lt;code&gt;matricks&lt;/code&gt; package in &lt;strong&gt;0.8.2&lt;/strong&gt; version has been released on CRAN! In
this post I will present you, what are advantages of using &lt;code&gt;matricks&lt;/code&gt;
and how you can use it.&lt;/p&gt;
&lt;h3 id=&#34;creating-matrices&#34;&gt;Creating matrices&lt;/h3&gt;
&lt;p&gt;The main function the package started with is &lt;code&gt;m&lt;/code&gt;. It’s a smart shortcut
for creating matrices, especially usefull if you want to define a matrix
by enumerating all the elements row-by-row. Typically, if you want to
create a matrix in R, you can do it using &lt;code&gt;base&lt;/code&gt; function called
&lt;code&gt;matrix&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; ,&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;,
         &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,
         &lt;span style=&#34;color:#ae81ff&#34;&gt;9&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), nrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, byrow &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    3    4    7
## [2,]    5    8    0
## [3,]    9    2    1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Although it’s a very simple opeartion, the funtion call doesn’t look
tidy. Alternaively, we can use &lt;code&gt;tibble&lt;/code&gt; with its &lt;code&gt;frame_matrix&lt;/code&gt;
function, defining column names with formulae first.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(tibble)
&lt;span style=&#34;color:#a6e22e&#34;&gt;frame_matrix&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; c1, &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; c2, &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; c3,
                &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;,    &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;,    &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;,
                &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;,    &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;,    &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,
                &lt;span style=&#34;color:#ae81ff&#34;&gt;9&lt;/span&gt;,    &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,    &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      c1 c2 c3
## [1,]  3  4  7
## [2,]  5  8  0
## [3,]  9  2  1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, it’s still not a such powerfull tool as &lt;code&gt;matricks::m&lt;/code&gt; function
is. Let’s see an example.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(matricks)
&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; ,&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt;
  &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt;
  &lt;span style=&#34;color:#ae81ff&#34;&gt;9&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    3    4    7
## [2,]    5    8    0
## [3,]    9    2    1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As simple as that! We join following rows using &lt;code&gt;|&lt;/code&gt; operator. &lt;code&gt;m&lt;/code&gt;
function is very flexible and offers you much more than before mentioned
ones.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;6&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    1    2    3
## [2,]    4    6    7
## [3,]    2    1    4
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And here and example with bindig multiple matrices together:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat1   &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
mat2  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;antidiag&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(mat1, mat2&lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt;
  mat2, mat1)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3] [,4] [,5] [,6]
## [1,]    1    0    0    0    0    3
## [2,]    0    1    0    0    3    0
## [3,]    0    0    1    3    0    0
## [4,]    0    0    3    1    0    0
## [5,]    0    3    0    0    1    0
## [6,]    3    0    0    0    0    1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;By the way, &lt;code&gt;antidiag&lt;/code&gt; function can be found in the &lt;code&gt;matricks&lt;/code&gt; package
too.&lt;/p&gt;
&lt;h3 id=&#34;setting--accessing-values&#34;&gt;Setting &amp;amp; accessing values&lt;/h3&gt;
&lt;p&gt;These code&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
mat[1, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.3&lt;/span&gt;
mat[2, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;
mat[3, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;13&lt;/span&gt;
mat[2, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;
mat
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    0  0.3    0
## [2,]    0  0.5    7
## [3,]   13  0.0    0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;can be replaced with:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
mat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;set_values&lt;/span&gt;(mat,
                  &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.3&lt;/span&gt;,
                  &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;,
                  &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;13&lt;/span&gt;,
                  &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;)
mat
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    0  0.3    0
## [2,]    0  0.5    7
## [3,]   13  0.0    0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In some cases, traditional way we access a matrix element in &lt;code&gt;R&lt;/code&gt; may be
inconvenient. Consider situation shown below:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;sample.matrix &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
matrix.indices &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;),
                       &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;), &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;),
                       &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;))

&lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(idx in matrix.indices) {
  sample.matrix[idx[1], idx[2]] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; sample.matrix[idx[1], idx[2]] &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
}

sample.matrix
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    3    3    3
## [2,]    1    3    1
## [3,]    3    1    3
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It can be expressed conciser using matrix &lt;code&gt;at&lt;/code&gt; function.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;sample.matrix &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
matrix.indices &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;),
                       &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;), &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;),
                       &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;))

&lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(idx in matrix.indices) {
  &lt;span style=&#34;color:#a6e22e&#34;&gt;at&lt;/span&gt;(sample.matrix, idx) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;at&lt;/span&gt;(sample.matrix, idx) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
}
sample.matrix
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    3    3    3
## [2,]    1    3    1
## [3,]    3    1    3
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;plotting-matrix&#34;&gt;Plotting matrix&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;matrix&lt;/code&gt; objects haven’t had good automatized plotting function until
now. Let’s create and plot a sample matrix of random values.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;rmat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;runifm&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(rmat)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##           [,1]      [,2]      [,3]
## [1,] 0.3248890 0.1024049 0.3295454
## [2,] 0.8077164 0.7267801 0.1116789
## [3,] 0.4406909 0.4703106 0.7047498
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;plot&lt;/span&gt;(rmat)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;/post/2020-02-29-matricks-release/runifm_print.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;p&gt;And here the same using a matrix of random boolean values (&lt;code&gt;rboolm&lt;/code&gt;).&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;set.seed&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;)
rmat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rboolm&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(rmat)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##       [,1]  [,2]  [,3]
## [1,] FALSE  TRUE  TRUE
## [2,]  TRUE  TRUE FALSE
## [3,]  TRUE FALSE  TRUE
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;plot&lt;/span&gt;(rmat)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;/post/2020-02-29-matricks-release/rboolm_print.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;operators&#34;&gt;Operators&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;matricks&lt;/code&gt; contains a family of operators, which allows you to perform
column-/row-wise operation
(addition/subtraction/multiplication/division) between matrix and
vector.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt;
         &lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;|&lt;/span&gt;
         &lt;span style=&#34;color:#ae81ff&#34;&gt;7&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;9&lt;/span&gt;)
mat
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    1    2    3
## [2,]    4    5    6
## [3,]    7    8    9
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;vec &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;v&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
vec
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1]
## [1,]    1
## [2,]    2
## [3,]    3
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If we try to do a column-wise multiplication, we ecounter a problem.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; vec
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## Error in mat * vec: niezgodne tablice
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can bypass this error using &lt;code&gt;%m%&lt;/code&gt; function. It does what we want!&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat &lt;span style=&#34;color:#f92672&#34;&gt;%m%&lt;/span&gt; vec
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    1    2    3
## [2,]    8   10   12
## [3,]   21   24   27
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;There are also several other operators available.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat &lt;span style=&#34;color:#f92672&#34;&gt;%d%&lt;/span&gt; vec
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##          [,1]     [,2] [,3]
## [1,] 1.000000 2.000000    3
## [2,] 2.000000 2.500000    3
## [3,] 2.333333 2.666667    3
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat &lt;span style=&#34;color:#f92672&#34;&gt;%+%&lt;/span&gt; vec
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    2    3    4
## [2,]    6    7    8
## [3,]   10   11   12
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;mat &lt;span style=&#34;color:#f92672&#34;&gt;%-%&lt;/span&gt; vec
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##      [,1] [,2] [,3]
## [1,]    0    1    2
## [2,]    2    3    4
## [3,]    4    5    6
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I encourage you to familiarize with &lt;code&gt;matricks&lt;/code&gt;. Visit &lt;a href=&#34;https://krzjoa.github.io/matricks&#34;&gt;matrix
documentation&lt;/a&gt; site and learn more!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Time Series &amp; PyTorch - Training network to compute moving average</title>
      <author>joachimiak.krzysztof@gmail.com (Krzysztof Joachimiak)</author>
      <link>/2019/12/28/content/post/2019-12-28-pytorch-ts-v1/2019-12-28-pytorch-ts-v1/</link>
      <pubDate>Sat, 28 Dec 2019 00:00:00 +0000</pubDate>
      
      <guid>/2019/12/28/content/post/2019-12-28-pytorch-ts-v1/2019-12-28-pytorch-ts-v1/</guid>
      <description>&lt;p&gt;When it comes to applying neural networks to Time Series processing (or other kind of sequential data), first words that we&amp;rsquo;ll probably think of are &lt;strong&gt;recurrent&lt;/strong&gt; and &lt;strong&gt;convolutional&lt;/strong&gt; layers. That&amp;rsquo;s absolutely right! In this post we&amp;rsquo;ll pass, step-by-step, through one of the simpliest examples of convolutional layer application i.e. training network to compute moving average. Such example may seem to not be practical, however its simplicity allows us to trace whole process and understand, how to control network&amp;rsquo;s behaviour, to model the way the network works.&lt;/p&gt;
&lt;h3 id=&#34;1-downloading-the-data&#34;&gt;1. Downloading the data&lt;/h3&gt;
&lt;p&gt;First thing we have to do is to download or create fake time serie dataset. Let get a Shampoo sales dataset published by Rob Hyndman in his &lt;strong&gt;R package&lt;/strong&gt; &lt;code&gt;fma&lt;/code&gt; (which was a software appedix for the book &lt;em&gt;Forecasting: Methods and Applications&lt;/em&gt;). Originally this dataset can be found inside R script, but as we work with a Python libary PyTorch, it be better for us to load this data from csv file. Such file can be found, for instance, &lt;a href=&#34;https://raw.githubusercontent.com/jbrownlee/Datasets/master/shampoo.csv&#34;&gt;here&lt;/a&gt;. Supposing we work in &lt;strong&gt;Jupyter Notebook&lt;/strong&gt; on Linux, we can fetch this data running following command:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;## Download dataset&lt;/span&gt;
&lt;span style=&#34;color:#960050;background-color:#1e0010&#34;&gt;!&lt;/span&gt;wget https:&lt;span style=&#34;color:#f92672&#34;&gt;//&lt;/span&gt;raw&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;githubusercontent&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;com&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;jbrownlee&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;Datasets&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;master&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;shampoo&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;csv
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;2-loading-data-and-simple-visualization&#34;&gt;2. Loading data and simple visualization&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; pandas &lt;span style=&#34;color:#66d9ef&#34;&gt;as&lt;/span&gt; pd
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; matplotlib.pyplot &lt;span style=&#34;color:#66d9ef&#34;&gt;as&lt;/span&gt; plt

data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; pd&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;read_csv(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;shampoo.csv&amp;#34;&lt;/span&gt;)
plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;plot(data[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Sales&amp;#39;&lt;/span&gt;])
plt&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;show()         
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;/post/2019-12-28-pytorch-ts-v1/plot.png&#34; alt=&#34;png&#34;&gt;&lt;/p&gt;
&lt;p&gt;In this plot we can see an increasing trend, but in this excercise, data characterics make no diffeence for us.&lt;/p&gt;
&lt;h3 id=&#34;3-1-d-convolution-in-pytorch-lightning-quick-intro-or-reminder&#34;&gt;3. 1-d convolution in PyTorch: lightning-quick intro (or reminder)&lt;/h3&gt;
&lt;p&gt;In the case of &lt;strong&gt;univariate time series&lt;/strong&gt;, one-dimensional convolution is a sliding window applied over time series, an operation which consist of multiplications and additions. It was intuitively illustrated on the gif below.&lt;/p&gt;
&lt;center&gt;
&lt;img src=&#34;/post/2019-12-28-pytorch-ts-v1/conv1d.gif&#34; width=&#34;400&#34;&gt;
Source: https://blog.floydhub.com/reading-minds-with-deep-learning/
&lt;/center&gt;
&lt;p&gt;As you can see, output depend on input and &lt;strong&gt;kernel&lt;/strong&gt; values. Defining proper kernel, we can apply the operation we want. For example, using a &lt;strong&gt;(0.5, 0.5)&lt;/strong&gt; kernel, it will give us a two-element moving average. To test that, let&amp;rsquo;s do a simple experiment.&lt;/p&gt;
&lt;h3 id=&#34;4-computing-moving-average-with-pandas&#34;&gt;4. Computing moving average with &lt;code&gt;pandas&lt;/code&gt;&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;ts &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Sales
ts&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;head(&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;0    266.0
1    145.9
2    183.1
3    119.3
4    180.3
5    168.5
6    231.8
7    224.5
8    192.8
9    122.9
Name: Sales, dtype: float64
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Using &lt;code&gt;pandas&lt;/code&gt;, we can compute moving average by combining &lt;code&gt;rolling&lt;/code&gt; and &lt;code&gt;mean&lt;/code&gt; method calls. We use &lt;code&gt;head&lt;/code&gt; method as well, to limit the output. By the way, this example shows the object-oriented nature of &lt;code&gt;pandas&lt;/code&gt;, which allows us to chain following methodc calls. Other fact that is worth to mention is a &lt;strong&gt;NaN&lt;/strong&gt; occurrence in the first row. It&amp;rsquo;s because we can&amp;rsquo;t compute moving avearge for the first element if we haven&amp;rsquo;t added any padding on the beginnng of the array; moreover, &lt;code&gt;pandas&lt;/code&gt; keeps the input&amp;rsquo;s length, so the first element has no value.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# rolling(2) means that we use a sliding window of length 2&lt;/span&gt;
ts&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;rolling(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;mean()&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;head(&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;0       NaN
1    205.95
2    164.50
3    151.20
4    149.80
5    174.40
6    200.15
7    228.15
8    208.65
9    157.85
Name: Sales, dtype: float64
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;5-computing-moving-average-with-pytorch&#34;&gt;5. Computing moving average with PyTorch&lt;/h3&gt;
&lt;p&gt;Now, let&amp;rsquo;s reproduce this result using 1-dimensional convolution from PyTorch.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; torch
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; torch.nn &lt;span style=&#34;color:#66d9ef&#34;&gt;as&lt;/span&gt; nn
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; torch.optim &lt;span style=&#34;color:#66d9ef&#34;&gt;as&lt;/span&gt; optim
&lt;span style=&#34;color:#f92672&#34;&gt;import&lt;/span&gt; torch.nn.functional &lt;span style=&#34;color:#66d9ef&#34;&gt;as&lt;/span&gt; F
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;print(len(ts))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;36
&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;ts_tensor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; torch&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Tensor(ts)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;reshape(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s stop here for a moment. If you are not familiar with deep learning frameworks, you would be quite confused because of this &lt;code&gt;reshape&lt;/code&gt; operation. What did we do above? We created a &lt;strong&gt;3-dimensional tensor&lt;/strong&gt;; each number in &lt;code&gt;reshape&lt;/code&gt; function describes respectively:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;number of samples&lt;/li&gt;
&lt;li&gt;number of channels&lt;/li&gt;
&lt;li&gt;length of time series&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Meaning of this values requires some explanation.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Number of samples&lt;/strong&gt; is the number of time series we are working on. As we want to perform computations for one time series only, the value must equal one.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Number of channels&lt;/strong&gt; is is the number of &lt;strong&gt;features&lt;/strong&gt; or (independent) &lt;strong&gt;variables&lt;/strong&gt;. We don&amp;rsquo;t have any parallel variables contaning information about, say, temperature or population. It&amp;rsquo;s clear that this value must equal one too.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Length of time series&lt;/strong&gt;. Accordingly to Python tensor reshaping convention, minus one means &lt;em&gt;infer value for this dimension&lt;/em&gt;. If one-dimensional time series length has 36 elements, after reshaping it to three-dimensional tensor with &lt;em&gt;number_of_samples&lt;/em&gt; = 1 and &lt;em&gt;number_of_channels&lt;/em&gt; = 1, the last value will be equal to 36.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;We have to do the same with the kernel.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;kernel &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [&lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;]
kernel_tensor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; torch&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Tensor(kernel)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;reshape(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
F&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;conv1d(ts_tensor, kernel_tensor)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;tensor([[[205.9500, 164.5000, 151.2000, 149.8000, 174.4000, 200.1500, 228.1500,
          208.6500, 157.8500, 229.7000, 261.2000, 190.1000, 171.9000, 179.8000,
          241.7000, 232.3500, 239.2000, 256.5000, 264.8000, 296.7500, 355.7500,
          343.0500, 303.4000, 341.0000, 390.0500, 378.1500, 377.6000, 420.3000,
          419.3500, 506.4500, 491.5500, 544.8000, 578.6500, 528.3000, 614.1000]]])
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As we can observe, the result is identical with values returned by &lt;code&gt;pandas&lt;/code&gt; methods. The only difference is lack of &lt;strong&gt;NaN&lt;/strong&gt; on the beginning.&lt;/p&gt;
&lt;h3 id=&#34;6-learning-a-network-which-computes-moving-average&#34;&gt;6. Learning a network, which computes moving average&lt;/h3&gt;
&lt;p&gt;Now, let&amp;rsquo;s get to the point and train the network on the fully controllable example. I&amp;rsquo;ve called in this manner to distinguish it from the real-life ones. In most cases, when we train a machine learning model, we don&amp;rsquo;t know the optimal parameter values. We are just trying to choose the best ones, but have no guarantee that they are globally optimal. Here, the optimal kernel value is known and should equal &lt;strong&gt;[0.2, 0.2, 0.2, 0.2, 0.2]&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;X &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Sales
X_tensor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; torch&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Tensor(X)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;reshape(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;In the step below, we are preparing &lt;strong&gt;targets&lt;/strong&gt; (&lt;strong&gt;labels&lt;/strong&gt;), which equals to the five-element moving average.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;y &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Sales&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;rolling(&lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;mean()
y &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; y[&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;:, ]&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;to_numpy()
y_tensor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; torch&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Tensor(y)&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;reshape(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
y_tensor
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;tensor([[[178.9200, 159.4200, 176.6000, 184.8800, 199.5800, 188.1000, 221.7000,
          212.5200, 206.4800, 197.8200, 215.2600, 202.6200, 203.7200, 222.2600,
          237.5600, 256.2600, 259.5800, 305.6200, 301.1200, 324.3800, 331.6000,
          361.7000, 340.5600, 375.5200, 387.3200, 406.8600, 433.8800, 452.2200,
          500.7600, 515.5600, 544.3400, 558.6200]]])
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We are building a one-layer convlutional neural network. It&amp;rsquo;s good to highlight, that &lt;strong&gt;we don&amp;rsquo;t use any nonlinear activation function&lt;/strong&gt;. Last numerical value describes the length of the kernel, &lt;em&gt;padding_mode = &amp;lsquo;valid&amp;rsquo;&lt;/em&gt; means that we don&amp;rsquo;t add any padding to the input, so we have to expect that output will be &amp;ldquo;trimmed&amp;rdquo;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Building a network&lt;/span&gt;
net &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; nn&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Conv1d(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;, padding_mode &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;valid&amp;#34;&lt;/span&gt;, bias &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;False&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Kernel is already initialized with, assume it for simplicity, &lt;em&gt;random&lt;/em&gt; values.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Initial values&lt;/span&gt;
net&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;weight&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;numpy()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;array([[[-0.26035744, -0.03702363,  0.36730862, -0.02416185,
          0.13382941]]], dtype=float32)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can perfom a convolution operation using this random value, calling &lt;strong&gt;net.forward()&lt;/strong&gt; or simply &lt;strong&gt;net()&lt;/strong&gt; (because Conv1d layer is a &lt;a href=&#34;https://stackoverflow.com/questions/5824881/python-call-special-method-practical-example/5826283&#34;&gt;callable object&lt;/a&gt;). This two operations are equivalent.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;net(X_tensor)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;tensor([[[ 13.8443,  17.2486,  41.0878,  48.5995,  52.3392,  41.7977,  44.2186,
           -3.6977,  90.3636,  39.1391,   1.3805,  30.8177,  40.0606,  87.4678,
           28.7942,  62.3456,  54.0152,  77.8429,  61.6129, 104.4986,  43.2576,
           56.9010,  74.8728, 111.2240,  54.3756,  83.8423, 115.3400,  72.0719,
          172.1338,  61.6583, 151.8888, 115.7389]]],
       grad_fn=&amp;lt;SqueezeBackward1&amp;gt;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We are initializing an optimizer object. I highly encourage you to experiment and start with &lt;strong&gt;SGD&lt;/strong&gt; which may do not converge.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Training a network&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# optimizer = optim.SGD(net.parameters(), lr=0.01, momentum=0.9)&lt;/span&gt;
optimizer &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; optim&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;Adam(net&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;parameters(), lr&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.01&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here, he have only one example so it does not make sense to divide training into epochs&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;running_loss &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.0&lt;/span&gt;
&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; iteration &lt;span style=&#34;color:#f92672&#34;&gt;in&lt;/span&gt; range(&lt;span style=&#34;color:#ae81ff&#34;&gt;1001&lt;/span&gt;):
    &lt;span style=&#34;color:#75715e&#34;&gt;# Zeroing gradients. For more,&lt;/span&gt;
    &lt;span style=&#34;color:#75715e&#34;&gt;# see: https://stackoverflow.com/questions/48001598/why-do-we-need-to-call-zero-grad-in-pytorch&lt;/span&gt;
    optimizer&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;zero_grad()

    &lt;span style=&#34;color:#75715e&#34;&gt;# Forward propagation&lt;/span&gt;
    outputs &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; net(X_tensor)  

    &lt;span style=&#34;color:#75715e&#34;&gt;# Mean squared error&lt;/span&gt;
    loss_value &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; torch&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;mean((outputs &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; y_tensor)&lt;span style=&#34;color:#f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)

    &lt;span style=&#34;color:#75715e&#34;&gt;# Computing gradients&lt;/span&gt;
    loss_value&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;backward()

    &lt;span style=&#34;color:#75715e&#34;&gt;# Changing network parameters with optimizer&lt;/span&gt;
    optimizer&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;step()

    &lt;span style=&#34;color:#75715e&#34;&gt;# Extractin loss value from tensor&lt;/span&gt;
    running_loss &lt;span style=&#34;color:#f92672&#34;&gt;+=&lt;/span&gt; loss_value&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;item()

    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; iteration &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;:
        print(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;[&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;%d&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;] loss: &lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;%.3f&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;%&lt;/span&gt; (iteration, loss_value&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;item()))
        print(net&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;weight&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;data&lt;span style=&#34;color:#f92672&#34;&gt;.&lt;/span&gt;numpy())

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;[0] loss: 65233.992
[[[-0.25035745 -0.02702364  0.3773086  -0.01416185  0.14382942]]]
[50] loss: 766.905
[[[-0.10564941  0.11878491  0.5043409   0.1344783   0.27711937]]]
[100] loss: 543.447
[[[-0.0883443   0.13628373  0.48577502  0.15751141  0.2710214 ]]]
[150] loss: 426.048
[[[-0.0724933   0.14859414  0.45826674  0.1760565   0.25820443]]]
[200] loss: 328.581
[[[-0.05417605  0.15856615  0.4295487   0.1921131   0.2450627 ]]]
[250] loss: 251.294
[[[-0.03332883  0.1663786   0.40218312  0.20528159  0.23343563]]]
[300] loss: 191.313
[[[-0.01093305  0.17196906  0.37692106  0.21512112  0.2236998 ]]]
[350] loss: 144.881
[[[0.01206546 0.17570996 0.3540248  0.22179407 0.21593276]]]
[400] loss: 108.854
[[[0.03480669 0.1781194  0.33345547 0.225752   0.2099969 ]]]
[450] loss: 80.925
[[[0.05659157 0.17970598 0.3150443  0.2275533  0.2056486 ]]]
[500] loss: 59.412
[[[0.07691177 0.18088101 0.29859436 0.22774552 0.20260815]]]
[550] loss: 43.023
[[[0.09544624 0.18192899 0.28392747 0.2268057  0.20060207]]]
[600] loss: 30.708
[[[0.11203615 0.18301436 0.2708983  0.22512004 0.19938451]]]
[650] loss: 21.594
[[[0.12664992 0.18420726 0.25938973 0.22298607 0.19874549]]]
[700] loss: 14.955
[[[0.13934767 0.18551382 0.24930081 0.2206255  0.19851226]]]
[750] loss: 10.198
[[[0.15024935 0.18690367 0.24053685 0.21819925 0.19854674]]]
[800] loss: 6.844
[[[0.15950975 0.18833081 0.23300111 0.21582113 0.19874188]]]
[850] loss: 4.520
[[[0.16729963 0.18974732 0.2265922  0.21356872 0.19901773]]]
[900] loss: 2.936
[[[0.17379297 0.19111133 0.2212036  0.21149167 0.19931738]]]
[950] loss: 1.876
[[[0.17915842 0.19239034 0.21672578 0.20961851 0.19960271]]]
[1000] loss: 1.178
[[[0.18355425 0.19356234 0.21304895 0.20796107 0.19985096]]]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As we can see in this example, algorithm converges and parameter values are becoming close to the &lt;strong&gt;true solution&lt;/strong&gt;, i.e.
&lt;strong&gt;[0.2, 0.2, 0.2, 0.2, 0.2]&lt;/strong&gt;.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
